@page "/"
@page "/home"
@inject NavigationManager NavigationManager
@inject HttpClient Http
@inject Blazored.SessionStorage.ISessionStorageService sessionStorage

<div class="bg-light">

    <div class="container text-dark py-4">
        <h3 class="mb-3">Find the perfect room</h3>

        <div class="bg-white border border-dark p-4">
            <form class="needs-validation" onsubmit="return false">
                <div class="form-group row">
                    <label for="inlineFormCustomSelect" class="col-sm-2 col-form-label">Room category:</label>
                    <select class="form-control col-sm-10" id="inlineFormCustomSelect" required @bind="roomIndex">
                        <option selected>Choose category</option>
                        <option value="1">Standard</option>
                        <option value="2">Deluxe</option>
                        <option value="3">Suite</option>
                    </select>
                </div>

                <div class="form-group row">
                    <label for="checkInDate" class="col-sm-2 col-form-label">Check-in:</label>
                    <input type="date" min="2021-04-01" class="form-control col-sm-10" id="checkInDate" required @bind="checkInDate">
                </div>

                <div class="form-group row">
                    <label for="checkOutDate" class="col-sm-2 col-form-label">Check-out:</label>
                    <input type="date" min="2021-04-01" class="form-control col-sm-10" id="checkOutDate" required @bind="checkOutDate">
                </div>

                <div class="form-group row">
                    <label for="personsNumber" class="col-sm-2 col-form-label">Persons number:</label>
                    <input type="number" min="1" max="10" class="form-control col-sm-10" id="personsNumber" required @bind="numberOfPersons">
                </div>

                <button type="submit" class="btn btn-outline-dark" @onclick='(() => RequestRooms())'>Search</button>
            </form>
        </div>
    </div>
    @if (roomsToDisplay != null)
    {
        <div class="container">
            <h3 class="mt-3">Rooms that match your search</h3>

            <div class="row">
                @foreach (var room in roomsToDisplay)
                {
                    <a href="/room/@room.RoomNumber" class="col-md-3 mb-3 p-3 text-dark" style="text-decoration: none;">
                        <div class="card shadow-sm">
                            <img class="card-img-top img-fluid" style="min-height:15rem; object-fit:cover;" src="images/109169996.jpg" alt="Room name">
                            <div class="card-body">
                                <p class="font-weight-bold text-primary mb-2">@room.RoomCategory @room.RoomNumber</p>
                                <p class="my-1">Starting from @room.Price lei</p>
                                <p class="my-1">Rating: 9.3</p>
                            </div>
                        </div>
                    </a>
                }
            </div>
        </div>
    }

    <div class="container">
        <h3 class="mt-3">Rooms clients love</h3>

        <div class="row">
            @for (int i = 0; i < 10; i++)
            {
                <a href="/room/@i" class="col-md-3 mb-3 p-3 text-dark" style="text-decoration: none;">
                    <div class="card shadow-sm">
                        <img class="card-img-top img-fluid" style="min-height:15rem; object-fit:cover;" src="images/109169996.jpg" alt="Room name">
                        <div class="card-body">
                            <p class="font-weight-bold text-primary mb-2">Room name</p>
                            <p class="my-1">Starting from 120 lei</p>
                            <p class="my-1">Rating: 9.3</p>
                        </div>
                    </div>
                </a>
            }
        </div>
    </div>

</div>


@code {
    public int roomIndex;
    public DateTime checkInDate;
    public DateTime checkOutDate;
    public int numberOfPersons;
    public List<string> roomTypes = new List<string> { "Standard", "Deluxe", "Suite"};
    public List<Room> roomsToDisplay;

    public async Task RequestRooms()
    {
        string checkInDateString = checkInDate.ToString("yyyy-MM-dd HH:mm:ss");
        string checkOutDateString = checkOutDate.ToString("yyyy-MM-dd HH:mm:ss");
        if (roomIndex == 0 || checkInDateString == "0001-01-01 00:00:00" || checkOutDateString == "0001-01-01 00:00:00" || numberOfPersons == 0)
            return;

        string roomType = roomTypes[roomIndex - 1];
        string getRoomsApiUrl = $"http://localhost:5100/api/v1/bookings/search?RoomCategory={roomType}&CheckIn={checkInDateString}&CheckOut={checkOutDateString}&PersonsNumber={numberOfPersons}";
        var getRequest = new HttpRequestMessage(HttpMethod.Get, getRoomsApiUrl);
        using var httpResponse = await Http.SendAsync(getRequest);
        RoomListDeserializer roomListDeserializer = await httpResponse.Content.ReadFromJsonAsync<RoomListDeserializer>();
        roomsToDisplay = roomListDeserializer.rooms;
        Console.WriteLine(roomsToDisplay[0].RoomNumber);
    }

    public class Room
    {
        public string RoomCategory { get; set; }

        public int RoomNumber { get; set; }

        public string Description { get; set; }

        public int Price { get; set; }

        public string Facilities { get; set; }

        public int PersonsNumber { get; set; }

    }

    public class RoomListDeserializer
    {
        public List<Room> rooms { get; set; }
    }

}
