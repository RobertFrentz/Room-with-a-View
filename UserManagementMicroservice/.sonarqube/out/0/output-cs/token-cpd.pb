§ƒ
ÖC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Controllers\UsersController.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Controllers% 0
{ 
[ 
Route 

(
 
$str 
) 
] 
[ 
ApiController 
] 
public 

class 
UsersController  
:! "
ControllerBase# 1
{ 
private 
readonly 
IUsersRepository )
_repository* 5
;5 6
[ 	)
ActivatorUtilitiesConstructor	 &
]& '
public 
UsersController 
( 
IUsersRepository /

repository0 :
): ;
{ 	
_repository 
= 

repository $
;$ %
} 	
public 
UsersController 
( 
)  
{ 	
}   	
[!! 	
HttpGet!!	 
]!! 
public"" 
async"" 
Task"" 
<"" 
IActionResult"" '
>""' (
GetAllAsync"") 4
(""4 5
[""5 6

FromHeader""6 @
]""@ A
string""B H
authorizationToken""I [
)""[ \
{## 	
var$$ 
result$$ 
=$$ 
	CheckAuth$$  
($$  !
authorizationToken$$! 3
)$$3 4
as$$5 7
ObjectResult$$8 D
;$$D E
var%% 
response%% 
=%% 
await%%  
_repository%%! ,
.%%, -
GetAllAsync%%- 8
(%%8 9
Jwt%%9 <
.%%< =
ExtractUserId%%= J
(%%J K
result%%K Q
.%%Q R
Value%%R W
.%%W X
ToString%%X `
(%%` a
)%%a b
)%%b c
)%%c d
;%%d e
if&& 
(&& 
response&& 
==&& 
null&&  
)&&  !
{'' 
return(( 
Unauthorized(( #
(((# $
new(($ '
Error((( -
(((- .
$str((. I
)((I J
)((J K
;((K L
})) 
return** 
Ok** 
(** 
response** 
)** 
;**  
}++ 	
[-- 	
HttpGet--	 
(-- 
$str-- 
,-- 
Name-- 
=-- 
$str--  )
)--) *
]--* +
public.. 
async.. 
Task.. 
<.. 
IActionResult.. '
>..' (
GetById..) 0
(..0 1
int..1 4
id..5 7
)..7 8
{// 	
var00 
result00 
=00 
await00 
_repository00 *
.00* +
GetByIdAsync00+ 7
(007 8
id008 :
)00: ;
;00; <
if11 
(11 
result11 
==11 
null11 
)11 
{22 
return33 
NotFound33 
(33  
new33  #
Error33$ )
(33) *
$"33* ,
$str33, 9
{339 :
id33: <
}33< =
$str33= L
"33L M
)33M N
)33N O
;33O P
}44 
return55 
Ok55 
(55 
result55 
)55 
;55 
}66 	
[88 	
Route88	 
(88 
$str88 
)88 
]88 
[99 	
HttpGet99	 
]99 
public:: 
async:: 
Task:: 
<:: 
IActionResult:: '
>::' ( 
GetStaffMembersAsync::) =
(::= >
[::> ?

FromHeader::? I
]::I J
string::K Q
authorizationToken::R d
)::d e
{;; 	
var<< 
jsonObjectResult<<  
=<<! "
	CheckAuth<<# ,
(<<, -
authorizationToken<<- ?
)<<? @
as<<A C
ObjectResult<<D P
;<<P Q
if== 
(== 
jsonObjectResult==  
is==! #$
UnauthorizedObjectResult==$ <
)==< =
{>> 
return?? 
jsonObjectResult?? '
;??' (
}@@ 
varAA 

priviligesAA 
=AA 
awaitAA "!
VerifyAdminPrivilegesAA# 8
(AA8 9
jsonObjectResultAA9 I
.AAI J
ValueAAJ O
.AAO P
ToStringAAP X
(AAX Y
)AAY Z
)AAZ [
;AA[ \
ifBB 
(BB 

priviligesBB 
isBB $
UnauthorizedObjectResultBB 6
)BB6 7
{CC 
returnDD 

priviligesDD !
;DD! "
}EE 
varFF 
responseFF 
=FF 
awaitFF  
_repositoryFF! ,
.FF, - 
GetStaffMembersAsyncFF- A
(FFA B
)FFB C
;FFC D
ifGG 
(GG 
responseGG 
==GG 
nullGG  
)GG  !
{HH 
returnII 
NotFoundII 
(II  
newII  #
ErrorII$ )
(II) *
$strII* K
)IIK L
)IIL M
;IIM N
}JJ 
returnKK 
OkKK 
(KK 
responseKK 
)KK 
;KK  
}MM 	
[OO 	
RouteOO	 
(OO 
$strOO 
)OO 
]OO 
[PP 	
HttpGetPP	 
]PP 
publicQQ 
asyncQQ 
TaskQQ 
<QQ 
IActionResultQQ '
>QQ' ( 
GetUserIdByNameAsyncQQ) =
(QQ= >
stringQQ> D
nameQQE I
)QQI J
{RR 	
varSS 
resultSS 
=SS 
awaitSS 
_repositorySS *
.SS* + 
GetUserIdByNameAsyncSS+ ?
(SS? @
nameSS@ D
)SSD E
;SSE F
ifTT 
(TT 
resultTT 
==TT 
$numTT 
)TT 
{UU 
returnVV 
NotFoundVV 
(VV  
newVV  #
ErrorVV$ )
(VV) *
$"VV* ,
$strVV, ;
{VV; <
nameVV< @
}VV@ A
$strVVA Q
"VVQ R
)VVR S
)VVS T
;VVT U
}WW 
returnXX 
OkXX 
(XX 
resultXX 
)XX 
;XX 
}YY 	
[[[ 	
Route[[	 
([[ 
$str[[ 
)[[ 
][[  
[\\ 	
HttpGet\\	 
]\\ 
public^^ 
IActionResult^^ 
	CheckAuth^^ &
(^^& '
[^^' (

FromHeader^^( 2
]^^2 3
string^^4 :
authorizationToken^^; M
)^^M N
{__ 	
var`` 
result`` 
=`` 
Jwt`` 
.`` 
CheckJWT`` %
(``% &
authorizationToken``& 8
)``8 9
;``9 :
ifaa 
(aa 
!aa 
Jwtaa 
.aa 

IsValidJWTaa 
(aa  
resultaa  &
)aa& '
)aa' (
{bb 
returncc 
Unauthorizedcc #
(cc# $
newcc$ '
Errorcc( -
(cc- .
resultcc. 4
)cc4 5
)cc5 6
;cc6 7
}dd 
returnee 
Okee 
(ee 
resultee 
)ee 
;ee 
}ff 	
[hh 	
Routehh	 
(hh 
$strhh  
)hh  !
]hh! "
[ii 	
HttpGetii	 
]ii 
publicjj 
asyncjj 
Taskjj 
<jj 
IActionResultjj '
>jj' (!
VerifyAdminPrivilegesjj) >
(jj> ?
stringjj? E
jsonjjF J
)jjJ K
{kk 	
varll 
resultll 
=ll 
awaitll 
_repositoryll *
.ll* +
HasAdminPrivilegesll+ =
(ll= >
Jwtll> A
.llA B
ExtractUserIdllB O
(llO P
jsonllP T
)llT U
)llU V
;llV W
ifmm 
(mm 
!mm 
resultmm 
)mm 
{nn 
returnoo 
Unauthorizedoo #
(oo# $
newoo$ '
Erroroo( -
(oo- .
$stroo. I
)ooI J
)ooJ K
;ooK L
}pp 
returnqq 
Okqq 
(qq 
resultqq 
)qq 
;qq 
}rr 	
[tt 	
Routett	 
(tt 
$strtt 
)tt 
]tt 
[uu 	
HttpGetuu	 
]uu 
publicvv 
asyncvv 
Taskvv 
<vv 
IActionResultvv '
>vv' (
GetByIdAsyncvv) 5
(vv5 6
[vv6 7

FromHeadervv7 A
]vvA B
stringvvC I
authorizationTokenvvJ \
)vv\ ]
{ww 	
varxx 
resultxx 
=xx 
	CheckAuthxx "
(xx" #
authorizationTokenxx# 5
)xx5 6
asxx7 9
ObjectResultxx: F
;xxF G
ifyy 
(yy 
resultyy 
isyy $
UnauthorizedObjectResultyy 1
)yy1 2
{zz 
return{{ 
result{{ 
;{{ 
}|| 
var}} 
response}} 
=}} 
await}}  
_repository}}! ,
.}}, -
GetByIdAsync}}- 9
(}}9 :
Jwt}}: =
.}}= >
ExtractUserId}}> K
(}}K L
result}}L R
.}}R S
Value}}S X
.}}X Y
ToString}}Y a
(}}a b
)}}b c
)}}c d
)}}d e
;}}e f
return~~ 
Ok~~ 
(~~ 
response~~ 
)~~ 
;~~  
} 	
[
ÅÅ 	
Route
ÅÅ	 
(
ÅÅ 
$str
ÅÅ 
)
ÅÅ 
]
ÅÅ 
[
ÇÇ 	
HttpGet
ÇÇ	 
]
ÇÇ 
public
ÉÉ 
async
ÉÉ 
Task
ÉÉ 
<
ÉÉ 
IActionResult
ÉÉ '
>
ÉÉ' (
GetUsernameAsync
ÉÉ) 9
(
ÉÉ9 :
[
ÉÉ: ;

FromHeader
ÉÉ; E
]
ÉÉE F
string
ÉÉG M 
authorizationToken
ÉÉN `
)
ÉÉ` a
{
ÑÑ 	
var
ÖÖ 
result
ÖÖ 
=
ÖÖ 
	CheckAuth
ÖÖ "
(
ÖÖ" # 
authorizationToken
ÖÖ# 5
)
ÖÖ5 6
as
ÖÖ7 9
ObjectResult
ÖÖ: F
;
ÖÖF G
if
ÜÜ 
(
ÜÜ 
result
ÜÜ 
is
ÜÜ &
UnauthorizedObjectResult
ÜÜ 2
)
ÜÜ2 3
{
áá 
return
àà 
result
àà 
;
àà 
}
ââ 
var
ää 
user
ää 
=
ää 
await
ää 
_repository
ää (
.
ää( )
GetByIdAsync
ää) 5
(
ää5 6
Jwt
ää6 9
.
ää9 :
ExtractUserId
ää: G
(
ääG H
result
ääH N
.
ääN O
Value
ääO T
.
ääT U
ToString
ääU ]
(
ää] ^
)
ää^ _
)
ää_ `
)
ää` a
;
ääa b
if
ãã 
(
ãã 
user
ãã 
==
ãã 
null
ãã 
)
ãã 
{
åå 
return
çç 
NotFound
çç 
(
çç  
new
çç  #
Error
çç$ )
(
çç) *
$str
çç* ?
)
çç? @
)
çç@ A
;
ççA B
}
éé 
return
èè 
Ok
èè 
(
èè 
JsonConvert
èè !
.
èè! "
SerializeObject
èè" 1
(
èè1 2
new
èè2 5
{
èè6 7
username
èè8 @
=
èèA B
user
èèC G
.
èèG H
Username
èèH P
}
èèQ R
)
èèR S
)
èèS T
;
èèT U
}
êê 	
[
íí 	
Route
íí	 
(
íí 
$str
íí 
)
íí 
]
íí 
[
ìì 	
HttpPost
ìì	 
]
ìì 
public
îî 
async
îî 
Task
îî 
<
îî 
IActionResult
îî '
>
îî' (
RegisterAsync
îî) 6
(
îî6 7
UserRegisterDto
îî7 F
userRegister
îîG S
,
îîS T
int
îîT W
role
îîX \
)
îî\ ]
{
ïï 	
var
ññ 
result
ññ 
=
ññ 
await
ññ 
_repository
ññ *
.
ññ* +
RegisterAsync
ññ+ 8
(
ññ8 9
userRegister
ññ9 E
,
ññE F
role
ññG K
)
ññK L
;
ññL M
if
óó 
(
óó 
result
óó 
==
óó 
-
óó 
$num
óó 
)
óó 
{
òò 
return
ôô 
Conflict
ôô 
(
ôô  
new
ôô  #
Error
ôô$ )
(
ôô) *
$str
ôô* @
)
ôô@ A
)
ôôA B
;
ôôB C
}
öö 
if
õõ 
(
õõ 
result
õõ 
==
õõ 
-
õõ 
$num
õõ 
)
õõ 
{
úú 
return
ùù 
Conflict
ùù 
(
ùù  
new
ùù  #
Error
ùù$ )
(
ùù) *
$str
ùù* C
)
ùùC D
)
ùùD E
;
ùùE F
}
ûû 
return
üü 
Ok
üü 
(
üü 
result
üü 
)
üü 
;
üü 
}
†† 	
[
££ 	
Route
££	 
(
££ 
$str
££ 
)
££  
]
££  !
[
§§ 	
HttpPost
§§	 
]
§§ 
public
•• 
async
•• 
Task
•• 
<
•• 
IActionResult
•• '
>
••' ( 
RegisterGuestAsync
••) ;
(
••; <
[
••< =
FromBody
••= E
]
••E F
UserRegisterDto
••G V
userRegister
••W c
)
••c d
{
¶¶ 	
var
ßß 
result
ßß 
=
ßß 
await
ßß 
RegisterAsync
ßß ,
(
ßß, -
userRegister
ßß- 9
,
ßß9 :
$num
ßß; <
)
ßß< =
;
ßß= >
if
®® 
(
®® 
result
®® 
is
®® "
ConflictObjectResult
®® .
)
®®. /
{
©© 
return
™™ 
result
™™ 
;
™™ 
}
´´ 
return
¨¨ 
CreatedAtAction
¨¨ "
(
¨¨" #
nameof
¨¨# )
(
¨¨) *
GetById
¨¨* 1
)
¨¨1 2
,
¨¨2 3
new
¨¨4 7
{
¨¨8 9
id
¨¨: <
=
¨¨= >
result
¨¨? E
}
¨¨F G
,
¨¨G H
userRegister
¨¨I U
)
¨¨U V
;
¨¨V W
}
≠≠ 	
[
ØØ 	
Route
ØØ	 
(
ØØ 
$str
ØØ 
)
ØØ  
]
ØØ  !
[
∞∞ 	
HttpPost
∞∞	 
]
∞∞ 
public
±± 
async
±± 
Task
±± 
<
±± 
IActionResult
±± '
>
±±' ( 
RegisterAdminAsync
±±) ;
(
±±; <
[
±±< =

FromHeader
±±= G
]
±±G H
string
±±I O 
authorizationToken
±±P b
,
±±b c
[
±±d e
FromBody
±±e m
]
±±m n
UserRegisterDto
±±o ~
userRegister±± ã
)±±ã å
{
≤≤ 	
var
≥≥ 
jsonObjectResult
≥≥  
=
≥≥! "
	CheckAuth
≥≥# ,
(
≥≥, - 
authorizationToken
≥≥- ?
)
≥≥? @
as
≥≥A C
ObjectResult
≥≥D P
;
≥≥P Q
if
¥¥ 
(
¥¥ 
jsonObjectResult
¥¥  
is
¥¥! #&
UnauthorizedObjectResult
¥¥$ <
)
¥¥< =
{
µµ 
return
∂∂ 
jsonObjectResult
∂∂ '
;
∂∂' (
}
∑∑ 
var
∏∏ 

priviliges
∏∏ 
=
∏∏ 
await
∏∏ "#
VerifyAdminPrivileges
∏∏# 8
(
∏∏8 9
jsonObjectResult
∏∏9 I
.
∏∏I J
Value
∏∏J O
.
∏∏O P
ToString
∏∏P X
(
∏∏X Y
)
∏∏Y Z
)
∏∏Z [
;
∏∏[ \
if
ππ 
(
ππ 

priviliges
ππ 
is
ππ &
UnauthorizedObjectResult
ππ 6
)
ππ6 7
{
∫∫ 
return
ªª 

priviliges
ªª !
;
ªª! "
}
ºº 
var
ΩΩ 
result
ΩΩ 
=
ΩΩ 
await
ΩΩ 
RegisterAsync
ΩΩ ,
(
ΩΩ, -
userRegister
ΩΩ- 9
,
ΩΩ9 :
$num
ΩΩ; <
)
ΩΩ< =
;
ΩΩ= >
if
ææ 
(
ææ 
result
ææ 
is
ææ "
ConflictObjectResult
ææ .
)
ææ. /
{
øø 
return
¿¿ 
result
¿¿ 
;
¿¿ 
}
¡¡ 
return
¬¬ 
CreatedAtAction
¬¬ "
(
¬¬" #
nameof
¬¬# )
(
¬¬) *
GetById
¬¬* 1
)
¬¬1 2
,
¬¬2 3
new
¬¬4 7
{
¬¬8 9
id
¬¬: <
=
¬¬= >
result
¬¬? E
}
¬¬F G
,
¬¬G H
userRegister
¬¬I U
)
¬¬U V
;
¬¬V W
}
√√ 	
[
≈≈ 	
Route
≈≈	 
(
≈≈ 
$str
≈≈ 
)
≈≈  
]
≈≈  !
[
∆∆ 	
HttpPost
∆∆	 
]
∆∆ 
public
«« 
async
«« 
Task
«« 
<
«« 
IActionResult
«« '
>
««' ( 
RegisterStaffAsync
««) ;
(
««; <
[
««< =

FromHeader
««= G
]
««G H
string
««I O 
authorizationToken
««P b
,
««b c
[
««d e
FromBody
««e m
]
««m n
UserRegisterDto
««o ~
userRegister«« ã
)««ã å
{
»» 	
var
…… 
jsonObjectResult
……  
=
……! "
	CheckAuth
……# ,
(
……, - 
authorizationToken
……- ?
)
……? @
as
……A C
ObjectResult
……D P
;
……P Q
if
   
(
   
jsonObjectResult
    
is
  ! #&
UnauthorizedObjectResult
  $ <
)
  < =
{
ÀÀ 
return
ÃÃ 
jsonObjectResult
ÃÃ '
;
ÃÃ' (
}
ÕÕ 
var
ŒŒ 

priviliges
ŒŒ 
=
ŒŒ 
await
ŒŒ "#
VerifyAdminPrivileges
ŒŒ# 8
(
ŒŒ8 9
jsonObjectResult
ŒŒ9 I
.
ŒŒI J
Value
ŒŒJ O
.
ŒŒO P
ToString
ŒŒP X
(
ŒŒX Y
)
ŒŒY Z
)
ŒŒZ [
;
ŒŒ[ \
if
œœ 
(
œœ 

priviliges
œœ 
is
œœ &
UnauthorizedObjectResult
œœ 6
)
œœ6 7
{
–– 
return
—— 

priviliges
—— !
;
——! "
}
““ 
var
”” 
result
”” 
=
”” 
await
”” 
RegisterAsync
”” ,
(
””, -
userRegister
””- 9
,
””9 :
$num
””; <
)
””< =
;
””= >
if
‘‘ 
(
‘‘ 
result
‘‘ 
is
‘‘ "
ConflictObjectResult
‘‘ .
)
‘‘. /
{
’’ 
return
÷÷ 
result
÷÷ 
;
÷÷ 
}
◊◊ 
return
ÿÿ 
CreatedAtAction
ÿÿ "
(
ÿÿ" #
nameof
ÿÿ# )
(
ÿÿ) *
GetById
ÿÿ* 1
)
ÿÿ1 2
,
ÿÿ2 3
new
ÿÿ4 7
{
ÿÿ8 9
id
ÿÿ: <
=
ÿÿ= >
result
ÿÿ? E
}
ÿÿF G
,
ÿÿG H
userRegister
ÿÿI U
)
ÿÿU V
;
ÿÿV W
}
ŸŸ 	
[
€€ 	
Route
€€	 
(
€€ 
$str
€€ 
)
€€ 
]
€€ 
[
‹‹ 	
HttpPost
‹‹	 
]
‹‹ 
public
›› 
async
›› 
Task
›› 
<
›› 
IActionResult
›› '
>
››' (

LoginAsync
››) 3
(
››3 4
[
››4 5
FromBody
››5 =
]
››= > 
UserCredentialsDto
››? Q
userCredentials
››R a
)
››a b
{
ﬁﬁ 	
var
ﬂﬂ 
user
ﬂﬂ 
=
ﬂﬂ 
await
ﬂﬂ 
_repository
ﬂﬂ (
.
ﬂﬂ( )

LoginAsync
ﬂﬂ) 3
(
ﬂﬂ3 4
userCredentials
ﬂﬂ4 C
)
ﬂﬂC D
;
ﬂﬂD E
if
‡‡ 
(
‡‡ 
user
‡‡ 
==
‡‡ 
null
‡‡ 
)
‡‡ 
{
·· 
return
‚‚ 

BadRequest
‚‚ !
(
‚‚! "
new
‚‚" %
Error
‚‚& +
(
‚‚+ ,
$str
‚‚, G
)
‚‚G H
)
‚‚H I
;
‚‚I J
}
„„ 
string
‰‰ 
userRole
‰‰ 
=
‰‰ 
(
‰‰ 
(
‰‰  
Role
‰‰  $
)
‰‰$ %
user
‰‰% )
.
‰‰) *
Role
‰‰* .
)
‰‰. /
.
‰‰/ 0
ToString
‰‰0 8
(
‰‰8 9
)
‰‰9 :
;
‰‰: ;
return
ÂÂ 
Ok
ÂÂ 
(
ÂÂ 
JsonConvert
ÂÂ !
.
ÂÂ! "
SerializeObject
ÂÂ" 1
(
ÂÂ1 2
new
ÂÂ2 5
{
ÂÂ6 7
jwt
ÂÂ8 ;
=
ÂÂ< =
Jwt
ÂÂ> A
.
ÂÂA B
	CreateJWT
ÂÂB K
(
ÂÂK L
user
ÂÂL P
.
ÂÂP Q
Id
ÂÂQ S
,
ÂÂS T
$num
ÂÂU V
)
ÂÂV W
,
ÂÂW X
role
ÂÂY ]
=
ÂÂ^ _
userRole
ÂÂ` h
}
ÂÂi j
)
ÂÂj k
)
ÂÂk l
;
ÂÂl m
}
ËË 	
[
ÍÍ 	
HttpPut
ÍÍ	 
]
ÍÍ 
public
ÎÎ 
async
ÎÎ 
Task
ÎÎ 
<
ÎÎ 
IActionResult
ÎÎ '
>
ÎÎ' (
UpdateAsync
ÎÎ) 4
(
ÎÎ4 5
[
ÎÎ5 6
FromBody
ÎÎ6 >
]
ÎÎ> ?
UserRegisterDto
ÎÎ@ O
user
ÎÎP T
,
ÎÎT U
[
ÎÎU V

FromHeader
ÎÎV `
]
ÎÎ` a
string
ÎÎb h 
authorizationToken
ÎÎi {
)
ÎÎ{ |
{
ÏÏ 	
var
ÌÌ 
result
ÌÌ 
=
ÌÌ 
	CheckAuth
ÌÌ "
(
ÌÌ" # 
authorizationToken
ÌÌ# 5
)
ÌÌ5 6
as
ÌÌ7 9
ObjectResult
ÌÌ: F
;
ÌÌF G
if
ÓÓ 
(
ÓÓ 
result
ÓÓ 
is
ÓÓ &
UnauthorizedObjectResult
ÓÓ 2
)
ÓÓ2 3
{
ÔÔ 
return
 
result
 
;
 
}
ÒÒ 
bool
ÚÚ 
	isUpdated
ÚÚ 
=
ÚÚ 
await
ÚÚ "
_repository
ÚÚ# .
.
ÚÚ. /
UpdateAsync
ÚÚ/ :
(
ÚÚ: ;
user
ÚÚ; ?
,
ÚÚ? @
Jwt
ÚÚA D
.
ÚÚD E
ExtractUserId
ÚÚE R
(
ÚÚR S
result
ÚÚS Y
.
ÚÚY Z
Value
ÚÚZ _
.
ÚÚ_ `
ToString
ÚÚ` h
(
ÚÚh i
)
ÚÚi j
)
ÚÚj k
)
ÚÚk l
;
ÚÚl m
if
ÛÛ 
(
ÛÛ 
!
ÛÛ 
	isUpdated
ÛÛ 
)
ÛÛ 
{
ÙÙ 
return
ıı 
NotFound
ıı 
(
ıı  
new
ıı  #
Error
ıı$ )
(
ıı) *
$str
ıı* >
)
ıı> ?
)
ıı? @
;
ıı@ A
}
ˆˆ 
return
˜˜ 
	NoContent
˜˜ 
(
˜˜ 
)
˜˜ 
;
˜˜ 
}
¯¯ 	
[
˙˙ 	

HttpDelete
˙˙	 
]
˙˙ 
public
˚˚ 
async
˚˚ 
Task
˚˚ 
<
˚˚ 
IActionResult
˚˚ '
>
˚˚' (
DeleteAsync
˚˚) 4
(
˚˚4 5
[
˚˚5 6

FromHeader
˚˚6 @
]
˚˚@ A
string
˚˚B H 
authorizationToken
˚˚I [
)
˚˚[ \
{
¸¸ 	
var
˝˝ 
result
˝˝ 
=
˝˝ 
	CheckAuth
˝˝ "
(
˝˝" # 
authorizationToken
˝˝# 5
)
˝˝5 6
as
˝˝7 9
ObjectResult
˝˝: F
;
˝˝F G
if
˛˛ 
(
˛˛ 
result
˛˛ 
is
˛˛ &
UnauthorizedObjectResult
˛˛ 2
)
˛˛2 3
{
ˇˇ 
return
ÄÄ 
result
ÄÄ 
;
ÄÄ 
}
ÅÅ 
await
ÇÇ 
_repository
ÇÇ 
.
ÇÇ 
DeleteByIdAsync
ÇÇ -
(
ÇÇ- .
Jwt
ÇÇ. 1
.
ÇÇ1 2
ExtractUserId
ÇÇ2 ?
(
ÇÇ? @
result
ÇÇ@ F
.
ÇÇF G
Value
ÇÇG L
.
ÇÇL M
ToString
ÇÇM U
(
ÇÇU V
)
ÇÇV W
)
ÇÇW X
)
ÇÇX Y
;
ÇÇY Z
return
ÉÉ 
	NoContent
ÉÉ 
(
ÉÉ 
)
ÉÉ 
;
ÉÉ 
}
ÖÖ 	
}
áá 
}àà ˙

zC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Data\DataContext.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Data% )
{ 
public 

class 
DataContext 
: 
	DbContext (
{ 
public		 
DataContext		 
(		 
DbContextOptions		 +
options		, 3
)		3 4
:		5 6
base		7 ;
(		; <
options		< C
)		C D
{

 	
} 	
public 
DbSet 
< 
User 
> 
Users  
{! "
get# &
;& '
set( +
;+ ,
}- .
	protected 
override 
void 
OnModelCreating  /
(/ 0
ModelBuilder0 <
modelBuilder= I
)I J
{ 	
modelBuilder 
. 
Entity 
<  
User  $
>$ %
(% &
)& '
. 
Property !
(! "
user" &
=>' )
user* .
.. /
Id/ 1
)1 2
. 
ValueGeneratedOnAdd ,
(, -
)- .
;. /
} 	
} 
} “
C:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Data\IUsersRepository.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Data% )
{ 
public		 

	interface		 
IUsersRepository		 %
{

 
Task 
< 
int 
> 
RegisterAsync 
(  
UserRegisterDto  /
userRegister0 <
,< =
int> A
roleB F
)F G
;G H
Task 
< 
User 
> 

LoginAsync 
( 
UserCredentialsDto 0
userCredentials1 @
)@ A
;A B
Task 
< 
IEnumerable 
< 
User 
> 
> 
GetAllAsync  +
(+ ,
int, /
userId0 6
)6 7
;7 8
Task 
< 
User 
> 
GetByIdAsync 
(  
int  #
userId$ *
)* +
;+ ,
Task 
< 
int 
>  
GetUserIdByNameAsync &
(& '
string' -
name. 2
)2 3
;3 4
Task 
< 
bool 
> 
UpdateAsync 
( 
UserRegisterDto .
user/ 3
,3 4
int5 8
userId9 ?
)? @
;@ A
Task 
DeleteByIdAsync 
( 
int  
userId! '
)' (
;( )
Task 
< 
bool 
> 
HasAdminPrivileges %
(% &
int& )
userId* 0
)0 1
;1 2
Task 
< 
IEnumerable 
< 
StaffResponseDto )
>) *
>* + 
GetStaffMembersAsync, @
(@ A
)A B
;B C
} 
} ÷
ñC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Data\Migrations\20210420162254_InitialCreate.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Data% )
.) *

Migrations* 4
{ 
public 

partial 
class 
InitialCreate &
:' (
	Migration) 2
{ 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder		 
.		 
CreateTable		 (
(		( )
name

 
:

 
$str

 
,

 
columns 
: 
table 
=> !
new" %
{ 
Id 
= 
table 
. 
Column %
<% &
int& )
>) *
(* +
type+ /
:/ 0
$str1 :
,: ;
nullable< D
:D E
falseF K
)K L
. 

Annotation #
(# $
$str$ :
,: ;
true< @
)@ A
,A B
Username 
= 
table $
.$ %
Column% +
<+ ,
string, 2
>2 3
(3 4
type4 8
:8 9
$str: @
,@ A
nullableB J
:J K
trueL P
)P Q
,Q R
Email 
= 
table !
.! "
Column" (
<( )
string) /
>/ 0
(0 1
type1 5
:5 6
$str7 =
,= >
nullable? G
:G H
trueI M
)M N
,N O
Password 
= 
table $
.$ %
Column% +
<+ ,
string, 2
>2 3
(3 4
type4 8
:8 9
$str: @
,@ A
nullableB J
:J K
trueL P
)P Q
,Q R
Role 
= 
table  
.  !
Column! '
<' (
int( +
>+ ,
(, -
type- 1
:1 2
$str3 <
,< =
nullable> F
:F G
falseH M
)M N
} 
, 
constraints 
: 
table "
=># %
{ 
table 
. 

PrimaryKey $
($ %
$str% /
,/ 0
x1 2
=>3 5
x6 7
.7 8
Id8 :
): ;
;; <
} 
) 
; 
} 	
	protected 
override 
void 
Down  $
($ %
MigrationBuilder% 5
migrationBuilder6 F
)F G
{ 	
migrationBuilder 
. 
	DropTable &
(& '
name 
: 
$str 
) 
; 
} 	
} 
}   ö
sC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Data\Role.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Data% )
{ 
public 

enum 
Role 
{		 
Guest

 
,

 
Admin 
, 
Staff 
} 
} ä\
~C:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Data\UsersRepository.cs
	namespace

 	&
UserManagementMicroservice


 $
.

$ %
Data

% )
{ 
public 

class 
UsersRepository  
:! "
IUsersRepository# 3
{ 
private 
readonly 
DataContext $
context% ,
;, -
public 
UsersRepository 
( 
DataContext *
context+ 2
)2 3
{ 	
this 
. 
context 
= 
context "
;" #
} 	
public 
async 
Task 
< 
int 
> 
RegisterAsync ,
(, -
UserRegisterDto- <
userRegister= I
,I J
intK N
roleO S
)S T
{ 	
if 
( 
this 
. 
context 
. 
Users !
.! "
Any" %
(% &
user& *
=>+ -
user. 2
.2 3
Username3 ;
==< >
userRegister? K
.K L
UsernameL T
)T U
)U V
{ 
return 
- 
$num 
; 
} 
if 
( 
this 
. 
context 
. 
Users !
.! "
Any" %
(% &
user& *
=>+ -
user. 2
.2 3
Email3 8
==9 ;
Cryptography< H
.H I

HashStringI S
(S T
userRegisterT `
.` a
Emaila f
)f g
)g h
)h i
{ 
return 
- 
$num 
; 
} 
User   
registerUser   
=   
new   "
(  # $
userRegister  $ 0
.  0 1
Username  1 9
,  9 :
userRegister  ; G
.  G H
Email  H M
,  M N
userRegister  O [
.  [ \
Password  \ d
,  d e
role  f j
)  j k
;  k l
var!! 
user!! 
=!! 
this!! 
.!! 
context!! #
.!!# $
Add!!$ '
(!!' (
Cryptography!!( 4
.!!4 5
SecureUserData!!5 C
(!!C D
registerUser!!D P
)!!P Q
)!!Q R
;!!R S
await"" 
this"" 
."" 
context"" 
."" 
SaveChangesAsync"" /
(""/ 0
)""0 1
;""1 2
return## 
user## 
.## 
Entity## 
.## 
Id## !
;##! "
}$$ 	
public&& 
async&& 
Task&& 
<&& 
User&& 
>&& 

LoginAsync&&  *
(&&* +
UserCredentialsDto&&+ =
userCredentials&&> M
)&&M N
{'' 	
var(( 
user(( 
=(( 
await(( 
this(( !
.((! "
context((" )
.(() *
Users((* /
.((/ 0
Where((0 5
(((5 6
user((6 :
=>((; =
user((> B
.((B C
Email((C H
==((I K
Cryptography((L X
.((X Y

HashString((Y c
(((c d
userCredentials((d s
.((s t
Email((t y
)((y z
&&))* ,
user))- 1
.))1 2
Password))2 :
==)); =
Cryptography))> J
.))J K

HashString))K U
())U V
userCredentials))V e
.))e f
Password))f n
)))n o
)))o p
.))p q 
FirstOrDefaultAsync	))q Ñ
(
))Ñ Ö
)
))Ö Ü
;
))Ü á
if** 
(** 
user** 
==** 
null** 
)** 
{++ 
return,, 
null,, 
;,, 
}-- 
return.. 
user.. 
;.. 
}00 	
public22 
async22 
Task22 
<22 
bool22 
>22 
UpdateAsync22  +
(22+ ,
UserRegisterDto22, ;
user22< @
,22@ A
int22B E
userId22F L
)22L M
{33 	
var44
 
result44 
=44 
this44 
.44 
context44 #
.44# $
Users44$ )
.44) *
Find44* .
(44. /
userId44/ 5
)445 6
;446 7
if55
 
(55 
result55 
==55 
null55 
)55 
{66 
return77 
false77 
;77 
}88 
result99
 
.99 
Username99 
=99 
user99  
.99  !
Username99! )
??99* ,
result99- 3
.993 4
Username994 <
;99< =
result::
 
.:: 
Email:: 
=:: 
Cryptography:: %
.::% &

HashString::& 0
(::0 1
user::1 5
.::5 6
Email::6 ;
)::; <
??::= ?
result::@ F
.::F G
Email::G L
;::L M
result;;
 
.;; 
Password;; 
=;; 
Cryptography;; (
.;;( )

HashString;;) 3
(;;3 4
user;;4 8
.;;8 9
Password;;9 A
);;A B
??;;C E
result;;F L
.;;L M
Password;;M U
;;;U V
await<<
 
this<< 
.<< 
context<< 
.<< 
SaveChangesAsync<< -
(<<- .
)<<. /
;<</ 0
return==
 
true== 
;== 
}>> 	
public@@ 
async@@ 
Task@@ 
<@@ 
IEnumerable@@ %
<@@% &
User@@& *
>@@* +
>@@+ ,
GetAllAsync@@- 8
(@@8 9
int@@9 <
userId@@= C
)@@C D
{AA 	
varBB 
resultBB 
=BB 
awaitBB 
thisBB #
.BB# $
contextBB$ +
.BB+ ,
UsersBB, 1
.BB1 2
	FindAsyncBB2 ;
(BB; <
userIdBB< B
)BBB C
;BBC D
ifCC 
(CC 
resultCC 
==CC 
nullCC 
||CC  
resultCC! '
.CC' (
RoleCC( ,
!=CC- /
$numCC0 1
)CC1 2
{DD 
returnEE 
nullEE 
;EE 
}FF 
returnGG 
awaitGG 
thisGG 
.GG 
contextGG %
.GG% &
UsersGG& +
.GG+ ,
ToListAsyncGG, 7
(GG7 8
)GG8 9
;GG9 :
}HH 	
publicJJ 
asyncJJ 
TaskJJ 
<JJ 
UserJJ 
>JJ 
GetByIdAsyncJJ  ,
(JJ, -
intJJ- 0
userIdJJ1 7
)JJ7 8
{KK 	
varLL 
userLL 
=LL 
awaitLL 
thisLL !
.LL! "
contextLL" )
.LL) *
UsersLL* /
.LL/ 0
	FindAsyncLL0 9
(LL9 :
userIdLL: @
)LL@ A
;LLA B
ifMM 
(MM 
userMM 
==MM 
nullMM 
)MM 
{NN 
returnOO 
nullOO 
;OO 
}PP 
returnQQ 
userQQ 
;QQ 
}RR 	
publicTT 
asyncTT 
TaskTT 
DeleteByIdAsyncTT )
(TT) *
intTT* -
userIdTT. 4
)TT4 5
{UU 	
varVV 
userVV 
=VV 
awaitVV 
thisVV !
.VV! "
contextVV" )
.VV) *
UsersVV* /
.VV/ 0
	FindAsyncVV0 9
(VV9 :
userIdVV: @
)VV@ A
;VVA B
thisWW 
.WW 
contextWW 
.WW 
RemoveWW 
(WW  
userWW  $
)WW$ %
;WW% &
awaitXX 
thisXX 
.XX 
contextXX 
.XX 
SaveChangesAsyncXX /
(XX/ 0
)XX0 1
;XX1 2
}ZZ 	
public[[ 
async[[ 
Task[[ 
<[[ 
bool[[ 
>[[ 
HasAdminPrivileges[[  2
([[2 3
int[[3 6
userId[[7 =
)[[= >
{\\ 	
var]] 
user]] 
=]] 
await]] 
this]] !
.]]! "
context]]" )
.]]) *
Users]]* /
.]]/ 0
	FindAsync]]0 9
(]]9 :
userId]]: @
)]]@ A
;]]A B
if^^ 
(^^ 
user^^ 
==^^ 
null^^ 
)^^ 
{__ 
return`` 
false`` 
;`` 
}aa 
ifbb 
(bb 
userbb 
.bb 
Rolebb 
==bb 
$numbb 
)bb 
{cc 
returndd 
truedd 
;dd 
}ee 
returnff 
falseff 
;ff 
}gg 	
publicii 
asyncii 
Taskii 
<ii 
IEnumerableii %
<ii% &
StaffResponseDtoii& 6
>ii6 7
>ii7 8 
GetStaffMembersAsyncii9 M
(iiM N
)iiN O
{jj 	
varkk 
staffkk 
=kk 
awaitkk 
contextkk %
.kk% &
Userskk& +
.kk+ ,
Wherekk, 1
(kk1 2
userkk2 6
=>kk7 9
userkk: >
.kk> ?
Rolekk? C
==kkD F
$numkkG H
)kkH I
.kkI J
SelectkkJ P
(kkP Q
userkkQ U
=>kkV X
newll 
StaffResponseDtoll '
(ll' (
)ll( )
{mm 
Namenn 
=nn 
usernn "
.nn" #
Usernamenn# +
,nn+ ,
UserIdoo 
=oo 
useroo  $
.oo$ %
Idoo% '
}pp 
)pp 
.pp 
ToListAsyncpp !
(pp! "
)pp" #
;pp# $
ifqq 
(qq 
staffqq 
==qq 
nullqq 
)qq 
{rr 
returnss 
nullss 
;ss 
}tt 
returnuu 
staffuu 
;uu 
}vv 	
publicxx 
asyncxx 
Taskxx 
<xx 
intxx 
>xx  
GetUserIdByNameAsyncxx 3
(xx3 4
stringxx4 :
namexx; ?
)xx? @
{yy 	
varzz 
userzz 
=zz 
awaitzz 
thiszz !
.zz! "
contextzz" )
.zz) *
Userszz* /
.zz/ 0
Wherezz0 5
(zz5 6
userzz6 :
=>zz; =
userzz> B
.zzB C
UsernamezzC K
==zzL N
namezzO S
)zzS T
.zzT U
FirstOrDefaultAsynczzU h
(zzh i
)zzi j
;zzj k
if{{ 
({{ 
user{{ 
=={{ 
null{{ 
){{ 
{|| 
return}} 
$num}} 
;}} 
}~~ 
return 
user 
. 
Id 
; 
}
ÄÄ 	
}
ÅÅ 
}ÇÇ ã
C:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\DTOs\StaffResponseDto.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
DTOs% )
{ 
public 

class 
StaffResponseDto !
{		 
public

 
string

 
Name

 
{

 
get

  
;

  !
set

" %
;

% &
}

' (
public 
int 
UserId 
{ 
get 
;  
set! $
;$ %
}& '
} 
} Õ
ÅC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\DTOs\UserCredentialsDto.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
DTOs% )
{ 
public 

class 
UserCredentialsDto #
{ 
[ 	
RegularExpression	 
( 
$str 8
,8 9
ErrorMessage: F
=G H
$strI `
)` a
]a b
public		 
string		 
Email		 
{		 
get		 !
;		! "
set		# &
;		& '
}		( )
public

 
string

 
Password

 
{

  
get

! $
;

$ %
set

& )
;

) *
}

+ ,
} 
} ‚
~C:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\DTOs\UserRegisterDto.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
DTOs% )
{ 
public 

class 
UserRegisterDto  
{ 
public 
string 
Username 
{  
get! $
;$ %
set& )
;) *
}+ ,
[ 	
RegularExpression	 
( 
$str 8
,8 9
ErrorMessage: F
=G H
$strI `
)` a
]a b
public		 
string		 
Email		 
{		 
get		 !
;		! "
set		# &
;		& '
}		( )
public

 
string

 
Password

 
{

  
get

! $
;

$ %
set

& )
;

) *
}

+ ,
} 
} á
wC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Entities\User.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Entities% -
{ 
public 

class 
User 
{ 
public 
User 
( 
) 
{ 	
}

 	
public 
User 
( 
string 
username #
,# $
string% +
email, 1
,1 2
string3 9
password: B
,B C
intC F
roleG K
)K L
{ 	
Username 
= 
username 
;  
Email 
= 
email 
; 
Password 
= 
password 
;  
Role 
= 
role 
; 
} 	
public 
User 
( 
int 
Id 
, 
string "
username# +
,+ ,
string- 3
email4 9
,9 :
string; A
passwordB J
)J K
{ 	
this 
. 
Id 
= 
Id 
; 
Username 
= 
username 
;  
Email 
= 
email 
; 
Password 
= 
password 
;  
} 	
public 
int 
Id 
{ 
get 
; 
set  
;  !
}" #
public 
string 
Username 
{  
get! $
;$ %
set& )
;) *
}+ ,
[ 	
RegularExpression	 
( 
$str 8
,8 9
ErrorMessage: F
=G H
$strI `
)` a
]a b
public 
string 
Email 
{ 
get !
;! "
set# &
;& '
}( )
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
public!! 
int!! 
Role!! 
{!! 
get!! 
;!! 
set!! "
;!!" #
}!!$ %
}"" 
}## Ì

qC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Program.cs
	namespace 	&
UserManagementMicroservice
 $
{ 
public 

static 
class 
Program 
{ 
public 
static 
void 
Main 
(  
string  &
[& '
]' (
args) -
)- .
{		 	
CreateHostBuilder

 
(

 
args

 "
)

" #
.

# $
Build

$ )
(

) *
)

* +
.

+ ,
Run

, /
(

/ 0
)

0 1
;

1 2
} 	
public 
static 
IHostBuilder "
CreateHostBuilder# 4
(4 5
string5 ;
[; <
]< =
args> B
)B C
=>D F
Host 
.  
CreateDefaultBuilder %
(% &
args& *
)* +
. $
ConfigureWebHostDefaults )
() *

webBuilder* 4
=>5 7
{ 

webBuilder 
. 

UseStartup )
<) *
Startup* 1
>1 2
(2 3
)3 4
;4 5
} 
) 
; 
} 
} ä'
qC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Startup.cs
	namespace 	&
UserManagementMicroservice
 $
{ 
public 

class 
Startup 
{ 
readonly 
string $
MyAllowedSpecificOrigins 0
=1 2
$str3 J
;J K
public 
Startup 
( 
IConfiguration %
configuration& 3
)3 4
{ 	
Configuration 
= 
configuration )
;) *
} 	
public 
IConfiguration 
Configuration +
{, -
get. 1
;1 2
}3 4
public 
void 
ConfigureServices %
(% &
IServiceCollection& 8
services9 A
)A B
{ 	
services 
. 
AddControllers #
(# $
)$ %
;% &
services 
. 
AddDbContext !
<! "
DataContext" -
>- .
(. /
options/ 6
=>7 9
{ 
options   
.   
	UseSqlite   !
(  ! "
Configuration  " /
.  / 0
GetConnectionString  0 C
(  C D
$str  D W
)  W X
)  X Y
;  Y Z
}!! 
)!! 
;!! 
services## 
.## 
AddCors## 
(## 
options## $
=>##% '
{$$ 
options%% 
.%% 
	AddPolicy%% !
(%%! "$
MyAllowedSpecificOrigins%%" :
,%%: ;
builder%%< C
=>%%D F
{&& 
builder'' 
.'' 
AllowAnyHeader'' *
(''* +
)''+ ,
.(( 
AllowAnyMethod(( #
(((# $
)(($ %
.)) 
AllowAnyOrigin)) #
())# $
)))$ %
;))% &
}** 
)** 
;** 
}++ 
)++ 
;++ 
services,, 
.,, 
AddDataProtection,, &
(,,& '
),,' (
.-- &
UseCryptographicAlgorithms-- *
(--* +
new--+ ./
#AuthenticatedEncryptorConfiguration--/ R
(--R S
)--S T
{.. 
EncryptionAlgorithm// &
=//' (
EncryptionAlgorithm//) <
.//< =
AES_256_GCM//= H
,//H I
ValidationAlgorithm00 &
=00' (
ValidationAlgorithm00) <
.00< =

HMACSHA25600= G
}11 
)11 
;11 
services22 
.22 
AddTransient22 !
<22! "
IUsersRepository22" 2
,222 3
UsersRepository224 C
>22C D
(22D E
)22E F
;22F G
services33 
.33 
AddSwaggerGen33 "
(33" #
c33# $
=>33% '
{44 
c55 
.55 

SwaggerDoc55 
(55 
$str55 !
,55! "
new55# &
OpenApiInfo55' 2
{553 4
Title555 :
=55; <
$str55= Y
,55Y Z
Version55[ b
=55c d
$str55e i
}55j k
)55k l
;55l m
}66 
)66 
;66 
}77 	
public:: 
void:: 
	Configure:: 
(:: 
IApplicationBuilder:: 1
app::2 5
,::5 6
IWebHostEnvironment::7 J
env::K N
)::N O
{;; 	
if<< 
(<< 
env<< 
.<< 
IsDevelopment<< !
(<<! "
)<<" #
)<<# $
{== 
app>> 
.>> %
UseDeveloperExceptionPage>> -
(>>- .
)>>. /
;>>/ 0
app?? 
.?? 

UseSwagger?? 
(?? 
)??  
;??  !
app@@ 
.@@ 
UseSwaggerUI@@  
(@@  !
c@@! "
=>@@# %
c@@& '
.@@' (
SwaggerEndpoint@@( 7
(@@7 8
$str@@8 R
,@@R S
$str@@T s
)@@s t
)@@t u
;@@u v
}AA 
appCC 
.CC 
UseCorsCC 
(CC $
MyAllowedSpecificOriginsCC 0
)CC0 1
;CC1 2
appEE 
.EE 

UseRoutingEE 
(EE 
)EE 
;EE 
appGG 
.GG 
UseAuthorizationGG  
(GG  !
)GG! "
;GG" #
appII 
.II 
UseEndpointsII 
(II 
	endpointsII &
=>II' )
{JJ 
	endpointsKK 
.KK 
MapControllersKK (
(KK( )
)KK) *
;KK* +
}LL 
)LL 
;LL 
}MM 	
}NN 
}OO ú"
|C:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Utils\Cryptography.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Utils% *
{ 
public 

static 
class 
Cryptography $
{		 
private

 
static

 
readonly

 #
IDataProtectionProvider

  7#
_dataProtectionProvider

8 O
=

P Q"
DataProtectionProvider

R h
.

h i
Create

i o
(

o p
$str

p z
)

z {
;

{ |
private 
static 
readonly 
byte  $
[$ %
]% &
salt' +
=, -
{. /
$num0 4
,4 5
$num6 :
,: ;
$num< @
,@ A
$numB F
,F G
$numH L
,L M
$numN R
,R S
$numT X
,X Y
$numZ ^
,^ _
$num` d
,d e
$numf j
,j k
$numl p
,p q
$numr v
,v w
$numx |
,| }
$num	~ Ç
,
Ç É
$num
Ñ à
,
à â
$num
ä é
}
è ê
;
ê ë
private 
const 
string 
Key  
=! "
$str# @
;@ A
public 
static 
User 
SecureUserData )
() *
User* .
user/ 3
)3 4
{ 	
User 

userHashed 
= 
new !
(! "
user" &
.& '
Username' /
,/ 0

HashString1 ;
(; <
user< @
.@ A
EmailA F
)F G
,G H

HashStringI S
(S T
userT X
.X Y
PasswordY a
)a b
,b c
userd h
.h i
Rolei m
)m n
;n o
return 

userHashed 
; 
} 	
public 
static 
string 

HashString '
(' (
string( .
	plaintext/ 8
)8 9
{ 	
if 
( 
	plaintext 
== 
null  
)  !
{ 
return 
null 
; 
} 
string 
hashed 
= 
Convert #
.# $
ToBase64String$ 2
(2 3
KeyDerivation3 @
.@ A
Pbkdf2A G
(G H
password 
: 
	plaintext 
, 
salt 
: 
salt 
, 
prf 
: 
KeyDerivationPrf  
.  !
HMACSHA1! )
,) *
iterationCount 
: 
$num  
,  !
numBytesRequested 
: 
$num !
/" #
$num$ %
)% &
)& '
;' (
return 
hashed 
; 
}   	
public!! 
static!! 
string!! 
Encrypt!! $
(!!$ %
string!!% +
input!!, 1
)!!1 2
{"" 	
var## 
	protector## 
=## #
_dataProtectionProvider## 3
.##3 4
CreateProtector##4 C
(##C D
Key##D G
)##G H
;##H I
return$$ 
	protector$$ 
.$$ 
Protect$$ $
($$$ %
input$$% *
)$$* +
;$$+ ,
}%% 	
public'' 
static'' 
string'' 
Decrypt'' $
(''$ %
string''% +

cipherText'', 6
)''6 7
{(( 	
var)) 
	protector)) 
=)) #
_dataProtectionProvider)) 3
.))3 4
CreateProtector))4 C
())C D
Key))D G
)))G H
;))H I
return** 
	protector** 
.** 
	Unprotect** &
(**& '

cipherText**' 1
)**1 2
;**2 3
}++ 	
},, 
}-- Ï
uC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Utils\Error.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Utils% *
{ 
public 

class 
Error 
{ 
public 
Error 
( 
string 
errorMessage (
)( )
{ 	
this 
. 
ErrorMessage 
= 
errorMessage  ,
;, -
} 	
public		 
string		 
ErrorMessage		 "
{		# $
get		% (
;		( )
set		* -
;		- .
}		/ 0
}

 
} ‡'
sC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Utils\Jwt.cs
	namespace

 	&
UserManagementMicroservice


 $
.

$ %
Utils

% *
{ 
public 

static 
class 
Jwt 
{ 
public 
static 
string 
	CreateJWT &
(& '
int' *
userId+ 1
,1 2
int3 6
time7 ;
); <
{ 	
var 
token 
= 
new 

JwtBuilder &
(& '
)' (
. 
WithAlgorithm )
() *
new* -
HMACSHA256Algorithm. A
(A B
)B C
)C D
. 

WithSecret &
(& '
$str' Q
)Q R
. 
AddClaim $
($ %
$str% *
,* +
DateTimeOffset, :
.: ;
UtcNow; A
.A B
AddHoursB J
(J K
timeK O
)O P
.P Q
ToUnixTimeSecondsQ b
(b c
)c d
)d e
. 
AddClaim $
($ %
$str% -
,- .
userId/ 5
)5 6
. 
Encode "
(" #
)# $
;$ %
return 
token 
; 
} 	
public 
static 
string 
CheckJWT %
(% &
string& ,
jwt- 0
)0 1
{ 	
string 
json 
; 
try 
{ 
IJsonSerializer 

serializer  *
=+ ,
new- 0
JsonNetSerializer1 B
(B C
)C D
;D E
var 
provider 
= 
new "
UtcDateTimeProvider# 6
(6 7
)7 8
;8 9
IJwtValidator   
	validator   '
=  ( )
new  * -
JwtValidator  . :
(  : ;

serializer  ; E
,  E F
provider  G O
)  O P
;  P Q
IBase64UrlEncoder!! !

urlEncoder!!" ,
=!!- .
new!!/ 2
JwtBase64UrlEncoder!!3 F
(!!F G
)!!G H
;!!H I
IJwtAlgorithm"" 
	algorithm"" '
=""( )
new""* -
HMACSHA256Algorithm"". A
(""A B
)""B C
;""C D
IJwtDecoder## 
decoder## #
=##$ %
new##& )

JwtDecoder##* 4
(##4 5

serializer##5 ?
,##? @
	validator##A J
,##J K

urlEncoder##L V
,##V W
	algorithm##X a
)##a b
;##b c
json$$ 
=$$ 
decoder$$ 
.$$ 
Decode$$ %
($$% &
jwt$$& )
,$$) *
$str$$+ U
,$$U V
verify$$W ]
:$$] ^
true$$_ c
)$$c d
;$$d e
}%% 
catch&& 
(&& !
TokenExpiredException&& (
)&&( )
{'' 
return(( 
$str(( *
;((* +
})) 
catch** 
(** *
SignatureVerificationException** 1
)**1 2
{++ 
return,, 
$str,, 4
;,,4 5
}-- 
return.. 
json.. 
;.. 
}// 	
public11 
static11 
bool11 

IsValidJWT11 %
(11% &
string11& ,
jwt11- 0
)110 1
{22 	
if33 
(33 
jwt33 
==33 
$str33 )
||33* ,
jwt33- 0
==331 3
$str334 Q
)33Q R
{44 
return55 
false55 
;55 
}66 
return77 
true77 
;77 
}88 	
public:: 
static:: 
int:: 
ExtractUserId:: '
(::' (
string::( .
jwt::/ 2
)::2 3
{;; 	
string<< 
claims<< 
=<< 
jwt<< 
.<<  
Split<<  %
(<<% &
$char<<& )
)<<) *
.<<* +
ToList<<+ 1
(<<1 2
)<<2 3
[<<3 4
$num<<4 5
]<<5 6
.<<6 7
Split<<7 <
(<<< =
$char<<= @
)<<@ A
.<<A B
ToList<<B H
(<<H I
)<<I J
[<<J K
$num<<K L
]<<L M
;<<M N
string== 
id== 
=== 
claims== 
.== 
Remove== %
(==% &
claims==& ,
.==, -
Length==- 3
-==4 5
$num==6 7
)==7 8
;==8 9
return>> 
Int32>> 
.>> 
Parse>> 
(>> 
id>> !
)>>! "
;>>" #
}?? 	
}@@ 
}AA 