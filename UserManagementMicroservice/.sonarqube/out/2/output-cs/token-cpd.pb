¨∆
ÖC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Controllers\UsersController.cs
	namespace

 	&
UserManagementMicroservice


 $
.

$ %
Controllers

% 0
{ 
[ 
Route 

(
 
$str 
) 
] 
[ 
ApiController 
] 
public 

class 
UsersController  
:! "
ControllerBase# 1
{ 
private 
readonly 
IUsersRepository )
_repository* 5
;5 6
[ 	)
ActivatorUtilitiesConstructor	 &
]& '
public 
UsersController 
( 
IUsersRepository /

repository0 :
): ;
{ 	
_repository 
= 

repository $
;$ %
} 	
public 
UsersController 
( 
)  
{ 	
} 	
[ 	
HttpGet	 
] 
public 
async 
Task 
< 
IActionResult '
>' (
GetAllAsync) 4
(4 5
[5 6

FromHeader6 @
]@ A
stringB H
authorizationTokenI [
)[ \
{   	
var!! 
result!! 
=!! 
	CheckAuth!!  
(!!  !
authorizationToken!!! 3
)!!3 4
as!!5 7
ObjectResult!!8 D
;!!D E
var"" 
response"" 
="" 
await""  
_repository""! ,
."", -
GetAllAsync""- 8
(""8 9
Jwt""9 <
.""< =
ExtractUserId""= J
(""J K
result""K Q
.""Q R
Value""R W
.""W X
ToString""X `
(""` a
)""a b
)""b c
)""c d
;""d e
if## 
(## 
response## 
==## 
null##  
)##  !
{$$ 
return%% 
Unauthorized%% #
(%%# $
new%%$ '
Error%%( -
(%%- .
$str%%. I
)%%I J
)%%J K
;%%K L
}&& 
return'' 
Ok'' 
('' 
response'' 
)'' 
;''  
}(( 	
[** 	
HttpGet**	 
(** 
$str** 
,** 
Name** 
=** 
$str**  )
)**) *
]*** +
public++ 
async++ 
Task++ 
<++ 
IActionResult++ '
>++' (
GetById++) 0
(++0 1
int++1 4
id++5 7
)++7 8
{,, 	
var-- 
result-- 
=-- 
await-- 
_repository-- *
.--* +
GetByIdAsync--+ 7
(--7 8
id--8 :
)--: ;
;--; <
if.. 
(.. 
result.. 
==.. 
null.. 
).. 
{// 
return00 
NotFound00 
(00  
new00  #
Error00$ )
(00) *
$"00* ,
$str00, 9
{009 :
id00: <
}00< =
$str00= L
"00L M
)00M N
)00N O
;00O P
}11 
return22 
Ok22 
(22 
result22 
)22 
;22 
}33 	
[55 	
Route55	 
(55 
$str55 
)55 
]55 
[66 	
HttpGet66	 
]66 
public77 
async77 
Task77 
<77 
IActionResult77 '
>77' ( 
GetStaffMembersAsync77) =
(77= >
[77> ?

FromHeader77? I
]77I J
string77K Q
authorizationToken77R d
)77d e
{88 	
var99 
jsonObjectResult99  
=99! "
	CheckAuth99# ,
(99, -
authorizationToken99- ?
)99? @
as99A C
ObjectResult99D P
;99P Q
if:: 
(:: 
jsonObjectResult::  
is::! #$
UnauthorizedObjectResult::$ <
)::< =
{;; 
return<< 
jsonObjectResult<< '
;<<' (
}== 
var>> 

priviliges>> 
=>> 
await>> "!
VerifyAdminPrivileges>># 8
(>>8 9
jsonObjectResult>>9 I
.>>I J
Value>>J O
.>>O P
ToString>>P X
(>>X Y
)>>Y Z
)>>Z [
;>>[ \
if?? 
(?? 

priviliges?? 
is?? $
UnauthorizedObjectResult?? 6
)??6 7
{@@ 
returnAA 

priviligesAA !
;AA! "
}BB 
varCC 
responseCC 
=CC 
awaitCC  
_repositoryCC! ,
.CC, - 
GetStaffMembersAsyncCC- A
(CCA B
)CCB C
;CCC D
ifDD 
(DD 
responseDD 
==DD 
nullDD  
)DD  !
{EE 
returnFF 
NotFoundFF 
(FF  
newFF  #
ErrorFF$ )
(FF) *
$strFF* K
)FFK L
)FFL M
;FFM N
}GG 
returnHH 
OkHH 
(HH 
responseHH 
)HH 
;HH  
}JJ 	
[LL 	
RouteLL	 
(LL 
$strLL 
)LL 
]LL 
[MM 	
HttpGetMM	 
]MM 
publicNN 
asyncNN 
TaskNN 
<NN 
IActionResultNN '
>NN' ( 
GetUserIdByNameAsyncNN) =
(NN= >
stringNN> D
nameNNE I
)NNI J
{OO 	
varPP 
resultPP 
=PP 
awaitPP 
_repositoryPP *
.PP* + 
GetUserIdByNameAsyncPP+ ?
(PP? @
namePP@ D
)PPD E
;PPE F
ifQQ 
(QQ 
resultQQ 
==QQ 
$numQQ 
)QQ 
{RR 
returnSS 
NotFoundSS 
(SS  
newSS  #
ErrorSS$ )
(SS) *
$"SS* ,
$strSS, ;
{SS; <
nameSS< @
}SS@ A
$strSSA Q
"SSQ R
)SSR S
)SSS T
;SST U
}TT 
returnUU 
OkUU 
(UU 
resultUU 
)UU 
;UU 
}VV 	
[XX 	
RouteXX	 
(XX 
$strXX 
)XX 
]XX  
[YY 	
HttpGetYY	 
]YY 
public[[ 
IActionResult[[ 
	CheckAuth[[ &
([[& '
[[[' (

FromHeader[[( 2
][[2 3
string[[4 :
authorizationToken[[; M
)[[M N
{\\ 	
var]] 
result]] 
=]] 
Jwt]] 
.]] 
CheckJWT]] %
(]]% &
authorizationToken]]& 8
)]]8 9
;]]9 :
if^^ 
(^^ 
!^^ 
Jwt^^ 
.^^ 

IsValidJWT^^ 
(^^  
result^^  &
)^^& '
)^^' (
{__ 
return`` 
Unauthorized`` #
(``# $
new``$ '
Error``( -
(``- .
result``. 4
)``4 5
)``5 6
;``6 7
}aa 
returnbb 
Okbb 
(bb 
resultbb 
)bb 
;bb 
}cc 	
[ee 	
Routeee	 
(ee 
$stree  
)ee  !
]ee! "
[ff 	
HttpGetff	 
]ff 
publicgg 
asyncgg 
Taskgg 
<gg 
IActionResultgg '
>gg' (!
VerifyAdminPrivilegesgg) >
(gg> ?
stringgg? E
jsonggF J
)ggJ K
{hh 	
varii 
resultii 
=ii 
awaitii 
_repositoryii *
.ii* +
HasAdminPrivilegesii+ =
(ii= >
Jwtii> A
.iiA B
ExtractUserIdiiB O
(iiO P
jsoniiP T
)iiT U
)iiU V
;iiV W
ifjj 
(jj 
!jj 
resultjj 
)jj 
{kk 
returnll 
Unauthorizedll #
(ll# $
newll$ '
Errorll( -
(ll- .
$strll. I
)llI J
)llJ K
;llK L
}mm 
returnnn 
Oknn 
(nn 
resultnn 
)nn 
;nn 
}oo 	
[qq 	
Routeqq	 
(qq 
$strqq 
)qq 
]qq 
[rr 	
HttpGetrr	 
]rr 
publicss 
asyncss 
Taskss 
<ss 
IActionResultss '
>ss' (
GetByIdAsyncss) 5
(ss5 6
[ss6 7

FromHeaderss7 A
]ssA B
stringssC I
authorizationTokenssJ \
)ss\ ]
{tt 	
varuu 
resultuu 
=uu 
	CheckAuthuu "
(uu" #
authorizationTokenuu# 5
)uu5 6
asuu7 9
ObjectResultuu: F
;uuF G
ifvv 
(vv 
resultvv 
isvv $
UnauthorizedObjectResultvv 1
)vv1 2
{ww 
returnxx 
resultxx 
;xx 
}yy 
varzz 
responsezz 
=zz 
awaitzz  
_repositoryzz! ,
.zz, -
GetByIdAsynczz- 9
(zz9 :
Jwtzz: =
.zz= >
ExtractUserIdzz> K
(zzK L
resultzzL R
.zzR S
ValuezzS X
.zzX Y
ToStringzzY a
(zza b
)zzb c
)zzc d
)zzd e
;zze f
return{{ 
Ok{{ 
({{ 
response{{ 
){{ 
;{{  
}|| 	
[~~ 	
Route~~	 
(~~ 
$str~~ 
)~~ 
]~~ 
[ 	
HttpGet	 
] 
public
ÄÄ 
async
ÄÄ 
Task
ÄÄ 
<
ÄÄ 
IActionResult
ÄÄ '
>
ÄÄ' (
GetUsernameAsync
ÄÄ) 9
(
ÄÄ9 :
[
ÄÄ: ;

FromHeader
ÄÄ; E
]
ÄÄE F
string
ÄÄG M 
authorizationToken
ÄÄN `
)
ÄÄ` a
{
ÅÅ 	
var
ÇÇ 
result
ÇÇ 
=
ÇÇ 
	CheckAuth
ÇÇ "
(
ÇÇ" # 
authorizationToken
ÇÇ# 5
)
ÇÇ5 6
as
ÇÇ7 9
ObjectResult
ÇÇ: F
;
ÇÇF G
if
ÉÉ 
(
ÉÉ 
result
ÉÉ 
is
ÉÉ &
UnauthorizedObjectResult
ÉÉ 2
)
ÉÉ2 3
{
ÑÑ 
return
ÖÖ 
result
ÖÖ 
;
ÖÖ 
}
ÜÜ 
var
áá 
user
áá 
=
áá 
await
áá 
_repository
áá (
.
áá( )
GetByIdAsync
áá) 5
(
áá5 6
Jwt
áá6 9
.
áá9 :
ExtractUserId
áá: G
(
ááG H
result
ááH N
.
ááN O
Value
ááO T
.
ááT U
ToString
ááU ]
(
áá] ^
)
áá^ _
)
áá_ `
)
áá` a
;
ááa b
if
àà 
(
àà 
user
àà 
==
àà 
null
àà 
)
àà 
{
ââ 
return
ää 
NotFound
ää 
(
ää  
new
ää  #
Error
ää$ )
(
ää) *
$str
ää* ?
)
ää? @
)
ää@ A
;
ääA B
}
ãã 
return
åå 
Ok
åå 
(
åå 
JsonConvert
åå !
.
åå! "
SerializeObject
åå" 1
(
åå1 2
new
åå2 5
{
åå6 7
username
åå8 @
=
ååA B
user
ååC G
.
ååG H
Username
ååH P
}
ååQ R
)
ååR S
)
ååS T
;
ååT U
}
çç 	
[
èè 	
Route
èè	 
(
èè 
$str
èè 
)
èè 
]
èè 
[
êê 	
HttpPost
êê	 
]
êê 
public
ëë 
async
ëë 
Task
ëë 
<
ëë 
IActionResult
ëë '
>
ëë' (
RegisterAsync
ëë) 6
(
ëë6 7
UserRegisterDto
ëë7 F
userRegister
ëëG S
,
ëëS T
int
ëëT W
role
ëëX \
)
ëë\ ]
{
íí 	
var
ìì 
result
ìì 
=
ìì 
await
ìì 
_repository
ìì *
.
ìì* +
RegisterAsync
ìì+ 8
(
ìì8 9
userRegister
ìì9 E
,
ììE F
role
ììG K
)
ììK L
;
ììL M
if
îî 
(
îî 
result
îî 
==
îî 
-
îî 
$num
îî 
)
îî 
{
ïï 
return
ññ 
Conflict
ññ 
(
ññ  
new
ññ  #
Error
ññ$ )
(
ññ) *
$str
ññ* @
)
ññ@ A
)
ññA B
;
ññB C
}
óó 
if
òò 
(
òò 
result
òò 
==
òò 
-
òò 
$num
òò 
)
òò 
{
ôô 
return
öö 
Conflict
öö 
(
öö  
new
öö  #
Error
öö$ )
(
öö) *
$str
öö* C
)
ööC D
)
ööD E
;
ööE F
}
õõ 
return
úú 
Ok
úú 
(
úú 
result
úú 
)
úú 
;
úú 
}
ùù 	
[
†† 	
Route
††	 
(
†† 
$str
†† 
)
††  
]
††  !
[
°° 	
HttpPost
°°	 
]
°° 
public
¢¢ 
async
¢¢ 
Task
¢¢ 
<
¢¢ 
IActionResult
¢¢ '
>
¢¢' ( 
RegisterGuestAsync
¢¢) ;
(
¢¢; <
[
¢¢< =
FromBody
¢¢= E
]
¢¢E F
UserRegisterDto
¢¢G V
userRegister
¢¢W c
)
¢¢c d
{
££ 	
var
§§ 
result
§§ 
=
§§ 
await
§§ 
RegisterAsync
§§ ,
(
§§, -
userRegister
§§- 9
,
§§9 :
$num
§§; <
)
§§< =
;
§§= >
if
•• 
(
•• 
result
•• 
is
•• "
ConflictObjectResult
•• .
)
••. /
{
¶¶ 
return
ßß 
result
ßß 
;
ßß 
}
®® 

MailSystem
©© 
.
©© "
SendRegistrationMail
©© +
(
©©+ ,
userRegister
©©, 8
.
©©8 9
Email
©©9 >
,
©©> ?
userRegister
©©@ L
.
©©L M
Username
©©M U
)
©©U V
;
©©V W
return
™™ 
CreatedAtAction
™™ "
(
™™" #
nameof
™™# )
(
™™) *
GetById
™™* 1
)
™™1 2
,
™™2 3
new
™™4 7
{
™™8 9
id
™™: <
=
™™= >
result
™™? E
}
™™F G
,
™™G H
userRegister
™™I U
)
™™U V
;
™™V W
}
´´ 	
[
≠≠ 	
Route
≠≠	 
(
≠≠ 
$str
≠≠ 
)
≠≠  
]
≠≠  !
[
ÆÆ 	
HttpPost
ÆÆ	 
]
ÆÆ 
public
ØØ 
async
ØØ 
Task
ØØ 
<
ØØ 
IActionResult
ØØ '
>
ØØ' ( 
RegisterAdminAsync
ØØ) ;
(
ØØ; <
[
ØØ< =

FromHeader
ØØ= G
]
ØØG H
string
ØØI O 
authorizationToken
ØØP b
,
ØØb c
[
ØØd e
FromBody
ØØe m
]
ØØm n
UserRegisterDto
ØØo ~
userRegisterØØ ã
)ØØã å
{
∞∞ 	
var
±± 
jsonObjectResult
±±  
=
±±! "
	CheckAuth
±±# ,
(
±±, - 
authorizationToken
±±- ?
)
±±? @
as
±±A C
ObjectResult
±±D P
;
±±P Q
if
≤≤ 
(
≤≤ 
jsonObjectResult
≤≤  
is
≤≤! #&
UnauthorizedObjectResult
≤≤$ <
)
≤≤< =
{
≥≥ 
return
¥¥ 
jsonObjectResult
¥¥ '
;
¥¥' (
}
µµ 
var
∂∂ 

priviliges
∂∂ 
=
∂∂ 
await
∂∂ "#
VerifyAdminPrivileges
∂∂# 8
(
∂∂8 9
jsonObjectResult
∂∂9 I
.
∂∂I J
Value
∂∂J O
.
∂∂O P
ToString
∂∂P X
(
∂∂X Y
)
∂∂Y Z
)
∂∂Z [
;
∂∂[ \
if
∑∑ 
(
∑∑ 

priviliges
∑∑ 
is
∑∑ &
UnauthorizedObjectResult
∑∑ 6
)
∑∑6 7
{
∏∏ 
return
ππ 

priviliges
ππ !
;
ππ! "
}
∫∫ 
var
ªª 
result
ªª 
=
ªª 
await
ªª 
RegisterAsync
ªª ,
(
ªª, -
userRegister
ªª- 9
,
ªª9 :
$num
ªª; <
)
ªª< =
;
ªª= >
if
ºº 
(
ºº 
result
ºº 
is
ºº "
ConflictObjectResult
ºº .
)
ºº. /
{
ΩΩ 
return
ææ 
result
ææ 
;
ææ 
}
øø 
return
¿¿ 
CreatedAtAction
¿¿ "
(
¿¿" #
nameof
¿¿# )
(
¿¿) *
GetById
¿¿* 1
)
¿¿1 2
,
¿¿2 3
new
¿¿4 7
{
¿¿8 9
id
¿¿: <
=
¿¿= >
result
¿¿? E
}
¿¿F G
,
¿¿G H
userRegister
¿¿I U
)
¿¿U V
;
¿¿V W
}
¡¡ 	
[
√√ 	
Route
√√	 
(
√√ 
$str
√√ 
)
√√  
]
√√  !
[
ƒƒ 	
HttpPost
ƒƒ	 
]
ƒƒ 
public
≈≈ 
async
≈≈ 
Task
≈≈ 
<
≈≈ 
IActionResult
≈≈ '
>
≈≈' ( 
RegisterStaffAsync
≈≈) ;
(
≈≈; <
[
≈≈< =

FromHeader
≈≈= G
]
≈≈G H
string
≈≈I O 
authorizationToken
≈≈P b
,
≈≈b c
[
≈≈d e
FromBody
≈≈e m
]
≈≈m n
UserRegisterDto
≈≈o ~
userRegister≈≈ ã
)≈≈ã å
{
∆∆ 	
var
«« 
jsonObjectResult
««  
=
««! "
	CheckAuth
««# ,
(
««, - 
authorizationToken
««- ?
)
««? @
as
««A C
ObjectResult
««D P
;
««P Q
if
»» 
(
»» 
jsonObjectResult
»»  
is
»»! #&
UnauthorizedObjectResult
»»$ <
)
»»< =
{
…… 
return
   
jsonObjectResult
   '
;
  ' (
}
ÀÀ 
var
ÃÃ 

priviliges
ÃÃ 
=
ÃÃ 
await
ÃÃ "#
VerifyAdminPrivileges
ÃÃ# 8
(
ÃÃ8 9
jsonObjectResult
ÃÃ9 I
.
ÃÃI J
Value
ÃÃJ O
.
ÃÃO P
ToString
ÃÃP X
(
ÃÃX Y
)
ÃÃY Z
)
ÃÃZ [
;
ÃÃ[ \
if
ÕÕ 
(
ÕÕ 

priviliges
ÕÕ 
is
ÕÕ &
UnauthorizedObjectResult
ÕÕ 6
)
ÕÕ6 7
{
ŒŒ 
return
œœ 

priviliges
œœ !
;
œœ! "
}
–– 
var
—— 
result
—— 
=
—— 
await
—— 
RegisterAsync
—— ,
(
——, -
userRegister
——- 9
,
——9 :
$num
——; <
)
——< =
;
——= >
if
““ 
(
““ 
result
““ 
is
““ "
ConflictObjectResult
““ .
)
““. /
{
”” 
return
‘‘ 
result
‘‘ 
;
‘‘ 
}
’’ 
return
÷÷ 
CreatedAtAction
÷÷ "
(
÷÷" #
nameof
÷÷# )
(
÷÷) *
GetById
÷÷* 1
)
÷÷1 2
,
÷÷2 3
new
÷÷4 7
{
÷÷8 9
id
÷÷: <
=
÷÷= >
result
÷÷? E
}
÷÷F G
,
÷÷G H
userRegister
÷÷I U
)
÷÷U V
;
÷÷V W
}
◊◊ 	
[
ŸŸ 	
Route
ŸŸ	 
(
ŸŸ 
$str
ŸŸ 
)
ŸŸ 
]
ŸŸ 
[
⁄⁄ 	
HttpPost
⁄⁄	 
]
⁄⁄ 
public
€€ 
async
€€ 
Task
€€ 
<
€€ 
IActionResult
€€ '
>
€€' (

LoginAsync
€€) 3
(
€€3 4
[
€€4 5
FromBody
€€5 =
]
€€= > 
UserCredentialsDto
€€? Q
userCredentials
€€R a
)
€€a b
{
‹‹ 	
var
›› 
user
›› 
=
›› 
await
›› 
_repository
›› (
.
››( )

LoginAsync
››) 3
(
››3 4
userCredentials
››4 C
)
››C D
;
››D E
if
ﬁﬁ 
(
ﬁﬁ 
user
ﬁﬁ 
==
ﬁﬁ 
null
ﬁﬁ 
)
ﬁﬁ 
{
ﬂﬂ 
return
‡‡ 

BadRequest
‡‡ !
(
‡‡! "
new
‡‡" %
Error
‡‡& +
(
‡‡+ ,
$str
‡‡, G
)
‡‡G H
)
‡‡H I
;
‡‡I J
}
·· 
string
‚‚ 
userRole
‚‚ 
=
‚‚ 
(
‚‚ 
(
‚‚  
Role
‚‚  $
)
‚‚$ %
user
‚‚% )
.
‚‚) *
Role
‚‚* .
)
‚‚. /
.
‚‚/ 0
ToString
‚‚0 8
(
‚‚8 9
)
‚‚9 :
;
‚‚: ;
return
„„ 
Ok
„„ 
(
„„ 
JsonConvert
„„ !
.
„„! "
SerializeObject
„„" 1
(
„„1 2
new
„„2 5
{
„„6 7
jwt
„„8 ;
=
„„< =
Jwt
„„> A
.
„„A B
	CreateJWT
„„B K
(
„„K L
user
„„L P
.
„„P Q
Id
„„Q S
,
„„S T
$num
„„U V
)
„„V W
,
„„W X
role
„„Y ]
=
„„^ _
userRole
„„` h
}
„„i j
)
„„j k
)
„„k l
;
„„l m
}
ÊÊ 	
[
ËË 	
HttpPut
ËË	 
]
ËË 
public
ÈÈ 
async
ÈÈ 
Task
ÈÈ 
<
ÈÈ 
IActionResult
ÈÈ '
>
ÈÈ' (
UpdateAsync
ÈÈ) 4
(
ÈÈ4 5
[
ÈÈ5 6
FromBody
ÈÈ6 >
]
ÈÈ> ?
UserRegisterDto
ÈÈ@ O
user
ÈÈP T
,
ÈÈT U
[
ÈÈU V

FromHeader
ÈÈV `
]
ÈÈ` a
string
ÈÈb h 
authorizationToken
ÈÈi {
)
ÈÈ{ |
{
ÍÍ 	
var
ÎÎ 
result
ÎÎ 
=
ÎÎ 
	CheckAuth
ÎÎ "
(
ÎÎ" # 
authorizationToken
ÎÎ# 5
)
ÎÎ5 6
as
ÎÎ7 9
ObjectResult
ÎÎ: F
;
ÎÎF G
if
ÏÏ 
(
ÏÏ 
result
ÏÏ 
is
ÏÏ &
UnauthorizedObjectResult
ÏÏ 2
)
ÏÏ2 3
{
ÌÌ 
return
ÓÓ 
result
ÓÓ 
;
ÓÓ 
}
ÔÔ 
bool
 
	isUpdated
 
=
 
await
 "
_repository
# .
.
. /
UpdateAsync
/ :
(
: ;
user
; ?
,
? @
Jwt
A D
.
D E
ExtractUserId
E R
(
R S
result
S Y
.
Y Z
Value
Z _
.
_ `
ToString
` h
(
h i
)
i j
)
j k
)
k l
;
l m
if
ÒÒ 
(
ÒÒ 
!
ÒÒ 
	isUpdated
ÒÒ 
)
ÒÒ 
{
ÚÚ 
return
ÛÛ 
NotFound
ÛÛ 
(
ÛÛ  
new
ÛÛ  #
Error
ÛÛ$ )
(
ÛÛ) *
$str
ÛÛ* >
)
ÛÛ> ?
)
ÛÛ? @
;
ÛÛ@ A
}
ÙÙ 
return
ıı 
	NoContent
ıı 
(
ıı 
)
ıı 
;
ıı 
}
ˆˆ 	
[
¯¯ 	

HttpDelete
¯¯	 
]
¯¯ 
public
˘˘ 
async
˘˘ 
Task
˘˘ 
<
˘˘ 
IActionResult
˘˘ '
>
˘˘' (
DeleteAsync
˘˘) 4
(
˘˘4 5
[
˘˘5 6

FromHeader
˘˘6 @
]
˘˘@ A
string
˘˘B H 
authorizationToken
˘˘I [
)
˘˘[ \
{
˙˙ 	
var
˚˚ 
result
˚˚ 
=
˚˚ 
	CheckAuth
˚˚ "
(
˚˚" # 
authorizationToken
˚˚# 5
)
˚˚5 6
as
˚˚7 9
ObjectResult
˚˚: F
;
˚˚F G
if
¸¸ 
(
¸¸ 
result
¸¸ 
is
¸¸ &
UnauthorizedObjectResult
¸¸ 2
)
¸¸2 3
{
˝˝ 
return
˛˛ 
result
˛˛ 
;
˛˛ 
}
ˇˇ 
await
ÄÄ 
_repository
ÄÄ 
.
ÄÄ 
DeleteByIdAsync
ÄÄ -
(
ÄÄ- .
Jwt
ÄÄ. 1
.
ÄÄ1 2
ExtractUserId
ÄÄ2 ?
(
ÄÄ? @
result
ÄÄ@ F
.
ÄÄF G
Value
ÄÄG L
.
ÄÄL M
ToString
ÄÄM U
(
ÄÄU V
)
ÄÄV W
)
ÄÄW X
)
ÄÄX Y
;
ÄÄY Z
return
ÅÅ 
	NoContent
ÅÅ 
(
ÅÅ 
)
ÅÅ 
;
ÅÅ 
}
ÉÉ 	
}
ÖÖ 
}ÜÜ Ç
zC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Data\DataContext.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Repositories% 1
{ 
public 

class 
DataContext 
: 
	DbContext (
{ 
public		 
DataContext		 
(		 
DbContextOptions		 +
options		, 3
)		3 4
:		5 6
base		7 ;
(		; <
options		< C
)		C D
{

 	
} 	
public 
DbSet 
< 
User 
> 
Users  
{! "
get# &
;& '
set( +
;+ ,
}- .
	protected 
override 
void 
OnModelCreating  /
(/ 0
ModelBuilder0 <
modelBuilder= I
)I J
{ 	
modelBuilder 
. 
Entity 
<  
User  $
>$ %
(% &
)& '
. 
Property !
(! "
user" &
=>' )
user* .
.. /
Id/ 1
)1 2
. 
ValueGeneratedOnAdd ,
(, -
)- .
;. /
} 	
} 
} ﬁ
ñC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Data\Migrations\20210420162254_InitialCreate.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Repositories% 1
.1 2

Migrations2 <
{ 
public 

partial 
class 
InitialCreate &
:' (
	Migration) 2
{ 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder		 
.		 
CreateTable		 (
(		( )
name

 
:

 
$str

 
,

 
columns 
: 
table 
=> !
new" %
{ 
Id 
= 
table 
. 
Column %
<% &
int& )
>) *
(* +
type+ /
:/ 0
$str1 :
,: ;
nullable< D
:D E
falseF K
)K L
. 

Annotation #
(# $
$str$ :
,: ;
true< @
)@ A
,A B
Username 
= 
table $
.$ %
Column% +
<+ ,
string, 2
>2 3
(3 4
type4 8
:8 9
$str: @
,@ A
nullableB J
:J K
trueL P
)P Q
,Q R
Email 
= 
table !
.! "
Column" (
<( )
string) /
>/ 0
(0 1
type1 5
:5 6
$str7 =
,= >
nullable? G
:G H
trueI M
)M N
,N O
Password 
= 
table $
.$ %
Column% +
<+ ,
string, 2
>2 3
(3 4
type4 8
:8 9
$str: @
,@ A
nullableB J
:J K
trueL P
)P Q
,Q R
Role 
= 
table  
.  !
Column! '
<' (
int( +
>+ ,
(, -
type- 1
:1 2
$str3 <
,< =
nullable> F
:F G
falseH M
)M N
} 
, 
constraints 
: 
table "
=># %
{ 
table 
. 

PrimaryKey $
($ %
$str% /
,/ 0
x1 2
=>3 5
x6 7
.7 8
Id8 :
): ;
;; <
} 
) 
; 
} 	
	protected 
override 
void 
Down  $
($ %
MigrationBuilder% 5
migrationBuilder6 F
)F G
{ 	
migrationBuilder 
. 
	DropTable &
(& '
name 
: 
$str 
) 
; 
} 	
} 
}   ã
C:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\DTOs\StaffResponseDto.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
DTOs% )
{ 
public 

class 
StaffResponseDto !
{		 
public

 
string

 
Name

 
{

 
get

  
;

  !
set

" %
;

% &
}

' (
public 
int 
UserId 
{ 
get 
;  
set! $
;$ %
}& '
} 
} Õ
ÅC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\DTOs\UserCredentialsDto.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
DTOs% )
{ 
public 

class 
UserCredentialsDto #
{ 
[ 	
RegularExpression	 
( 
$str 8
,8 9
ErrorMessage: F
=G H
$strI `
)` a
]a b
public		 
string		 
Email		 
{		 
get		 !
;		! "
set		# &
;		& '
}		( )
public

 
string

 
Password

 
{

  
get

! $
;

$ %
set

& )
;

) *
}

+ ,
} 
} ‚
~C:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\DTOs\UserRegisterDto.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
DTOs% )
{ 
public 

class 
UserRegisterDto  
{ 
public 
string 
Username 
{  
get! $
;$ %
set& )
;) *
}+ ,
[ 	
RegularExpression	 
( 
$str 8
,8 9
ErrorMessage: F
=G H
$strI `
)` a
]a b
public		 
string		 
Email		 
{		 
get		 !
;		! "
set		# &
;		& '
}		( )
public

 
string

 
Password

 
{

  
get

! $
;

$ %
set

& )
;

) *
}

+ ,
} 
} á
wC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Entities\User.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Entities% -
{ 
public 

class 
User 
{ 
public 
User 
( 
) 
{ 	
}

 	
public 
User 
( 
string 
username #
,# $
string% +
email, 1
,1 2
string3 9
password: B
,B C
intC F
roleG K
)K L
{ 	
Username 
= 
username 
;  
Email 
= 
email 
; 
Password 
= 
password 
;  
Role 
= 
role 
; 
} 	
public 
User 
( 
int 
Id 
, 
string "
username# +
,+ ,
string- 3
email4 9
,9 :
string; A
passwordB J
)J K
{ 	
this 
. 
Id 
= 
Id 
; 
Username 
= 
username 
;  
Email 
= 
email 
; 
Password 
= 
password 
;  
} 	
public 
int 
Id 
{ 
get 
; 
set  
;  !
}" #
public 
string 
Username 
{  
get! $
;$ %
set& )
;) *
}+ ,
[ 	
RegularExpression	 
( 
$str 8
,8 9
ErrorMessage: F
=G H
$strI `
)` a
]a b
public 
string 
Email 
{ 
get !
;! "
set# &
;& '
}( )
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
public!! 
int!! 
Role!! 
{!! 
get!! 
;!! 
set!! "
;!!" #
}!!$ %
}"" 
}## Ì

qC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Program.cs
	namespace 	&
UserManagementMicroservice
 $
{ 
public 

static 
class 
Program 
{ 
public 
static 
void 
Main 
(  
string  &
[& '
]' (
args) -
)- .
{		 	
CreateHostBuilder

 
(

 
args

 "
)

" #
.

# $
Build

$ )
(

) *
)

* +
.

+ ,
Run

, /
(

/ 0
)

0 1
;

1 2
} 	
public 
static 
IHostBuilder "
CreateHostBuilder# 4
(4 5
string5 ;
[; <
]< =
args> B
)B C
=>D F
Host 
.  
CreateDefaultBuilder %
(% &
args& *
)* +
. $
ConfigureWebHostDefaults )
() *

webBuilder* 4
=>5 7
{ 

webBuilder 
. 

UseStartup )
<) *
Startup* 1
>1 2
(2 3
)3 4
;4 5
} 
) 
; 
} 
} „
áC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Repositories\IUsersRepository.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Repositories% 1
{ 
public		 

	interface		 
IUsersRepository		 %
{

 
Task 
< 
int 
> 
RegisterAsync 
(  
UserRegisterDto  /
userRegister0 <
,< =
int> A
roleB F
)F G
;G H
Task 
< 
User 
> 

LoginAsync 
( 
UserCredentialsDto 0
userCredentials1 @
)@ A
;A B
Task 
< 
IEnumerable 
< 
User 
> 
> 
GetAllAsync  +
(+ ,
int, /
userId0 6
)6 7
;7 8
Task 
< 
User 
> 
GetByIdAsync 
(  
int  #
userId$ *
)* +
;+ ,
Task 
< 
int 
>  
GetUserIdByNameAsync &
(& '
string' -
name. 2
)2 3
;3 4
Task 
< 
bool 
> 
UpdateAsync 
( 
UserRegisterDto .
user/ 3
,3 4
int5 8
userId9 ?
)? @
;@ A
Task 
DeleteByIdAsync 
( 
int  
userId! '
)' (
;( )
Task 
< 
bool 
> 
HasAdminPrivileges %
(% &
int& )
userId* 0
)0 1
;1 2
Task 
< 
IEnumerable 
< 
StaffResponseDto )
>) *
>* + 
GetStaffMembersAsync, @
(@ A
)A B
;B C
} 
} õ\
ÜC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Repositories\UsersRepository.cs
	namespace

 	&
UserManagementMicroservice


 $
.

$ %
Repositories

% 1
{ 
public 

class 
UsersRepository  
:! "
IUsersRepository# 3
{ 
private 
readonly 
DataContext $
context% ,
;, -
public 
UsersRepository 
( 
DataContext *
context+ 2
)2 3
{ 	
this 
. 
context 
= 
context "
;" #
} 	
public 
async 
Task 
< 
int 
> 
RegisterAsync ,
(, -
UserRegisterDto- <
userRegister= I
,I J
intK N
roleO S
)S T
{ 	
if 
( 
this 
. 
context 
. 
Users !
.! "
Any" %
(% &
user& *
=>+ -
user. 2
.2 3
Username3 ;
==< >
userRegister? K
.K L
UsernameL T
)T U
)U V
{ 
return 
- 
$num 
; 
} 
if 
( 
this 
. 
context 
. 
Users !
.! "
Any" %
(% &
user& *
=>+ -
user. 2
.2 3
Email3 8
==9 ;
Cryptography< H
.H I

HashStringI S
(S T
userRegisterT `
.` a
Emaila f
)f g
)g h
)h i
{ 
return 
- 
$num 
; 
} 
User   
registerUser   
=   
new   "
(  # $
userRegister  $ 0
.  0 1
Username  1 9
,  9 :
userRegister  ; G
.  G H
Email  H M
,  M N
userRegister  O [
.  [ \
Password  \ d
,  d e
role  f j
)  j k
;  k l
var!! 
user!! 
=!! 
this!! 
.!! 
context!! #
.!!# $
Add!!$ '
(!!' (
Cryptography!!( 4
.!!4 5
SecureUserData!!5 C
(!!C D
registerUser!!D P
)!!P Q
)!!Q R
;!!R S
await"" 
this"" 
."" 
context"" 
."" 
SaveChangesAsync"" /
(""/ 0
)""0 1
;""1 2
return## 
user## 
.## 
Entity## 
.## 
Id## !
;##! "
}$$ 	
public&& 
async&& 
Task&& 
<&& 
User&& 
>&& 

LoginAsync&&  *
(&&* +
UserCredentialsDto&&+ =
userCredentials&&> M
)&&M N
{'' 	
var(( 
user(( 
=(( 
await(( 
this(( !
.((! "
context((" )
.(() *
Users((* /
.((/ 0
Where((0 5
(((5 6
user((6 :
=>((; =
user((> B
.((B C
Email((C H
==((I K
Cryptography((L X
.((X Y

HashString((Y c
(((c d
userCredentials((d s
.((s t
Email((t y
)((y z
&&))* ,
user))- 1
.))1 2
Password))2 :
==)); =
Cryptography))> J
.))J K

HashString))K U
())U V
userCredentials))V e
.))e f
Password))f n
)))n o
)))o p
.))p q 
FirstOrDefaultAsync	))q Ñ
(
))Ñ Ö
)
))Ö Ü
;
))Ü á
if** 
(** 
user** 
==** 
null** 
)** 
{++ 
return,, 
null,, 
;,, 
}-- 
return.. 
user.. 
;.. 
}00 	
public22 
async22 
Task22 
<22 
bool22 
>22 
UpdateAsync22  +
(22+ ,
UserRegisterDto22, ;
user22< @
,22@ A
int22B E
userId22F L
)22L M
{33 	
var44
 
result44 
=44 
this44 
.44 
context44 #
.44# $
Users44$ )
.44) *
Find44* .
(44. /
userId44/ 5
)445 6
;446 7
if55
 
(55 
result55 
==55 
null55 
)55 
{66 
return77 
false77 
;77 
}88 
result99
 
.99 
Username99 
=99 
user99  
.99  !
Username99! )
??99* ,
result99- 3
.993 4
Username994 <
;99< =
result::
 
.:: 
Email:: 
=:: 
Cryptography:: %
.::% &

HashString::& 0
(::0 1
user::1 5
.::5 6
Email::6 ;
)::; <
??::= ?
result::@ F
.::F G
Email::G L
;::L M
result;;
 
.;; 
Password;; 
=;; 
Cryptography;; (
.;;( )

HashString;;) 3
(;;3 4
user;;4 8
.;;8 9
Password;;9 A
);;A B
??;;C E
result;;F L
.;;L M
Password;;M U
;;;U V
await<<
 
this<< 
.<< 
context<< 
.<< 
SaveChangesAsync<< -
(<<- .
)<<. /
;<</ 0
return==
 
true== 
;== 
}>> 	
public@@ 
async@@ 
Task@@ 
<@@ 
IEnumerable@@ %
<@@% &
User@@& *
>@@* +
>@@+ ,
GetAllAsync@@- 8
(@@8 9
int@@9 <
userId@@= C
)@@C D
{AA 	
varBB 
resultBB 
=BB 
awaitBB 
thisBB #
.BB# $
contextBB$ +
.BB+ ,
UsersBB, 1
.BB1 2
	FindAsyncBB2 ;
(BB; <
userIdBB< B
)BBB C
;BBC D
ifCC 
(CC 
resultCC 
==CC 
nullCC 
||CC  
resultCC! '
.CC' (
RoleCC( ,
!=CC- /
$numCC0 1
)CC1 2
{DD 
returnEE 
nullEE 
;EE 
}FF 
returnGG 
awaitGG 
thisGG 
.GG 
contextGG %
.GG% &
UsersGG& +
.GG+ ,
ToListAsyncGG, 7
(GG7 8
)GG8 9
;GG9 :
}HH 	
publicJJ 
asyncJJ 
TaskJJ 
<JJ 
UserJJ 
>JJ 
GetByIdAsyncJJ  ,
(JJ, -
intJJ- 0
userIdJJ1 7
)JJ7 8
{KK 	
varLL 
userLL 
=LL 
awaitLL 
thisLL !
.LL! "
contextLL" )
.LL) *
UsersLL* /
.LL/ 0
	FindAsyncLL0 9
(LL9 :
userIdLL: @
)LL@ A
;LLA B
ifMM 
(MM 
userMM 
==MM 
nullMM 
)MM 
{NN 
returnOO 
nullOO 
;OO 
}PP 
returnQQ 
userQQ 
;QQ 
}RR 	
publicTT 
asyncTT 
TaskTT 
DeleteByIdAsyncTT )
(TT) *
intTT* -
userIdTT. 4
)TT4 5
{UU 	
varVV 
userVV 
=VV 
awaitVV 
thisVV !
.VV! "
contextVV" )
.VV) *
UsersVV* /
.VV/ 0
	FindAsyncVV0 9
(VV9 :
userIdVV: @
)VV@ A
;VVA B
thisWW 
.WW 
contextWW 
.WW 
RemoveWW 
(WW  
userWW  $
)WW$ %
;WW% &
awaitXX 
thisXX 
.XX 
contextXX 
.XX 
SaveChangesAsyncXX /
(XX/ 0
)XX0 1
;XX1 2
}ZZ 	
public[[ 
async[[ 
Task[[ 
<[[ 
bool[[ 
>[[ 
HasAdminPrivileges[[  2
([[2 3
int[[3 6
userId[[7 =
)[[= >
{\\ 	
var]] 
user]] 
=]] 
await]] 
this]] !
.]]! "
context]]" )
.]]) *
Users]]* /
.]]/ 0
	FindAsync]]0 9
(]]9 :
userId]]: @
)]]@ A
;]]A B
if^^ 
(^^ 
user^^ 
==^^ 
null^^ 
)^^ 
{__ 
return`` 
false`` 
;`` 
}aa 
ifbb 
(bb 
userbb 
.bb 
Rolebb 
==bb 
$numbb 
)bb 
{cc 
returndd 
truedd 
;dd 
}ee 
returnff 
falseff 
;ff 
}gg 	
publicii 
asyncii 
Taskii 
<ii 
IEnumerableii %
<ii% &
StaffResponseDtoii& 6
>ii6 7
>ii7 8 
GetStaffMembersAsyncii9 M
(iiM N
)iiN O
{jj 	
varkk 
staffkk 
=kk 
awaitkk 
contextkk %
.kk% &
Userskk& +
.kk+ ,
Wherekk, 1
(kk1 2
userkk2 6
=>kk7 9
userkk: >
.kk> ?
Rolekk? C
==kkD F
$numkkG H
)kkH I
.kkI J
SelectkkJ P
(kkP Q
userkkQ U
=>kkV X
newll 
StaffResponseDtoll '
(ll' (
)ll( )
{mm 
Namenn 
=nn 
usernn "
.nn" #
Usernamenn# +
,nn+ ,
UserIdoo 
=oo 
useroo  $
.oo$ %
Idoo% '
}pp 
)pp 
.pp 
ToListAsyncpp !
(pp! "
)pp" #
;pp# $
ifqq 
(qq 
staffqq 
==qq 
nullqq 
)qq 
{rr 
returnss 
nullss 
;ss 
}tt 
returnuu 
staffuu 
;uu 
}vv 	
publicxx 
asyncxx 
Taskxx 
<xx 
intxx 
>xx  
GetUserIdByNameAsyncxx 3
(xx3 4
stringxx4 :
namexx; ?
)xx? @
{yy 	
varzz 
userzz 
=zz 
awaitzz 
thiszz !
.zz! "
contextzz" )
.zz) *
Userszz* /
.zz/ 0
Wherezz0 5
(zz5 6
userzz6 :
=>zz; =
userzz> B
.zzB C
UsernamezzC K
==zzL N
namezzO S
)zzS T
.zzT U
FirstOrDefaultAsynczzU h
(zzh i
)zzi j
;zzj k
if{{ 
({{ 
user{{ 
=={{ 
null{{ 
){{ 
{|| 
return}} 
$num}} 
;}} 
}~~ 
return 
user 
. 
Id 
; 
}
ÄÄ 	
}
ÅÅ 
}ÇÇ ä'
qC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Startup.cs
	namespace 	&
UserManagementMicroservice
 $
{ 
public 

class 
Startup 
{ 
readonly 
string $
MyAllowedSpecificOrigins 0
=1 2
$str3 J
;J K
public 
Startup 
( 
IConfiguration %
configuration& 3
)3 4
{ 	
Configuration 
= 
configuration )
;) *
} 	
public 
IConfiguration 
Configuration +
{, -
get. 1
;1 2
}3 4
public 
void 
ConfigureServices %
(% &
IServiceCollection& 8
services9 A
)A B
{ 	
services 
. 
AddControllers #
(# $
)$ %
;% &
services 
. 
AddDbContext !
<! "
DataContext" -
>- .
(. /
options/ 6
=>7 9
{ 
options   
.   
	UseSqlite   !
(  ! "
Configuration  " /
.  / 0
GetConnectionString  0 C
(  C D
$str  D W
)  W X
)  X Y
;  Y Z
}!! 
)!! 
;!! 
services## 
.## 
AddCors## 
(## 
options## $
=>##% '
{$$ 
options%% 
.%% 
	AddPolicy%% !
(%%! "$
MyAllowedSpecificOrigins%%" :
,%%: ;
builder%%< C
=>%%D F
{&& 
builder'' 
.'' 
AllowAnyHeader'' *
(''* +
)''+ ,
.(( 
AllowAnyMethod(( #
(((# $
)(($ %
.)) 
AllowAnyOrigin)) #
())# $
)))$ %
;))% &
}** 
)** 
;** 
}++ 
)++ 
;++ 
services,, 
.,, 
AddDataProtection,, &
(,,& '
),,' (
.-- &
UseCryptographicAlgorithms-- *
(--* +
new--+ ./
#AuthenticatedEncryptorConfiguration--/ R
(--R S
)--S T
{.. 
EncryptionAlgorithm// &
=//' (
EncryptionAlgorithm//) <
.//< =
AES_256_GCM//= H
,//H I
ValidationAlgorithm00 &
=00' (
ValidationAlgorithm00) <
.00< =

HMACSHA25600= G
}11 
)11 
;11 
services22 
.22 
AddTransient22 !
<22! "
IUsersRepository22" 2
,222 3
UsersRepository224 C
>22C D
(22D E
)22E F
;22F G
services33 
.33 
AddSwaggerGen33 "
(33" #
c33# $
=>33% '
{44 
c55 
.55 

SwaggerDoc55 
(55 
$str55 !
,55! "
new55# &
OpenApiInfo55' 2
{553 4
Title555 :
=55; <
$str55= Y
,55Y Z
Version55[ b
=55c d
$str55e i
}55j k
)55k l
;55l m
}66 
)66 
;66 
}77 	
public:: 
void:: 
	Configure:: 
(:: 
IApplicationBuilder:: 1
app::2 5
,::5 6
IWebHostEnvironment::7 J
env::K N
)::N O
{;; 	
if<< 
(<< 
env<< 
.<< 
IsDevelopment<< !
(<<! "
)<<" #
)<<# $
{== 
app>> 
.>> %
UseDeveloperExceptionPage>> -
(>>- .
)>>. /
;>>/ 0
app?? 
.?? 

UseSwagger?? 
(?? 
)??  
;??  !
app@@ 
.@@ 
UseSwaggerUI@@  
(@@  !
c@@! "
=>@@# %
c@@& '
.@@' (
SwaggerEndpoint@@( 7
(@@7 8
$str@@8 R
,@@R S
$str@@T s
)@@s t
)@@t u
;@@u v
}AA 
appCC 
.CC 
UseCorsCC 
(CC $
MyAllowedSpecificOriginsCC 0
)CC0 1
;CC1 2
appEE 
.EE 

UseRoutingEE 
(EE 
)EE 
;EE 
appGG 
.GG 
UseAuthorizationGG  
(GG  !
)GG! "
;GG" #
appII 
.II 
UseEndpointsII 
(II 
	endpointsII &
=>II' )
{JJ 
	endpointsKK 
.KK 
MapControllersKK (
(KK( )
)KK) *
;KK* +
}LL 
)LL 
;LL 
}MM 	
}NN 
}OO ú"
|C:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Utils\Cryptography.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Utils% *
{ 
public 

static 
class 
Cryptography $
{		 
private

 
static

 
readonly

 #
IDataProtectionProvider

  7#
_dataProtectionProvider

8 O
=

P Q"
DataProtectionProvider

R h
.

h i
Create

i o
(

o p
$str

p z
)

z {
;

{ |
private 
static 
readonly 
byte  $
[$ %
]% &
salt' +
=, -
{. /
$num0 4
,4 5
$num6 :
,: ;
$num< @
,@ A
$numB F
,F G
$numH L
,L M
$numN R
,R S
$numT X
,X Y
$numZ ^
,^ _
$num` d
,d e
$numf j
,j k
$numl p
,p q
$numr v
,v w
$numx |
,| }
$num	~ Ç
,
Ç É
$num
Ñ à
,
à â
$num
ä é
}
è ê
;
ê ë
private 
const 
string 
Key  
=! "
$str# @
;@ A
public 
static 
User 
SecureUserData )
() *
User* .
user/ 3
)3 4
{ 	
User 

userHashed 
= 
new !
(! "
user" &
.& '
Username' /
,/ 0

HashString1 ;
(; <
user< @
.@ A
EmailA F
)F G
,G H

HashStringI S
(S T
userT X
.X Y
PasswordY a
)a b
,b c
userd h
.h i
Rolei m
)m n
;n o
return 

userHashed 
; 
} 	
public 
static 
string 

HashString '
(' (
string( .
	plaintext/ 8
)8 9
{ 	
if 
( 
	plaintext 
== 
null  
)  !
{ 
return 
null 
; 
} 
string 
hashed 
= 
Convert #
.# $
ToBase64String$ 2
(2 3
KeyDerivation3 @
.@ A
Pbkdf2A G
(G H
password 
: 
	plaintext 
, 
salt 
: 
salt 
, 
prf 
: 
KeyDerivationPrf  
.  !
HMACSHA1! )
,) *
iterationCount 
: 
$num  
,  !
numBytesRequested 
: 
$num !
/" #
$num$ %
)% &
)& '
;' (
return 
hashed 
; 
}   	
public!! 
static!! 
string!! 
Encrypt!! $
(!!$ %
string!!% +
input!!, 1
)!!1 2
{"" 	
var## 
	protector## 
=## #
_dataProtectionProvider## 3
.##3 4
CreateProtector##4 C
(##C D
Key##D G
)##G H
;##H I
return$$ 
	protector$$ 
.$$ 
Protect$$ $
($$$ %
input$$% *
)$$* +
;$$+ ,
}%% 	
public'' 
static'' 
string'' 
Decrypt'' $
(''$ %
string''% +

cipherText'', 6
)''6 7
{(( 	
var)) 
	protector)) 
=)) #
_dataProtectionProvider)) 3
.))3 4
CreateProtector))4 C
())C D
Key))D G
)))G H
;))H I
return** 
	protector** 
.** 
	Unprotect** &
(**& '

cipherText**' 1
)**1 2
;**2 3
}++ 	
},, 
}-- Ï
uC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Utils\Error.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Utils% *
{ 
public 

class 
Error 
{ 
public 
Error 
( 
string 
errorMessage (
)( )
{ 	
this 
. 
ErrorMessage 
= 
errorMessage  ,
;, -
} 	
public		 
string		 
ErrorMessage		 "
{		# $
get		% (
;		( )
set		* -
;		- .
}		/ 0
}

 
} ‡'
sC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Utils\Jwt.cs
	namespace

 	&
UserManagementMicroservice


 $
.

$ %
Utils

% *
{ 
public 

static 
class 
Jwt 
{ 
public 
static 
string 
	CreateJWT &
(& '
int' *
userId+ 1
,1 2
int3 6
time7 ;
); <
{ 	
var 
token 
= 
new 

JwtBuilder &
(& '
)' (
. 
WithAlgorithm )
() *
new* -
HMACSHA256Algorithm. A
(A B
)B C
)C D
. 

WithSecret &
(& '
$str' Q
)Q R
. 
AddClaim $
($ %
$str% *
,* +
DateTimeOffset, :
.: ;
UtcNow; A
.A B
AddHoursB J
(J K
timeK O
)O P
.P Q
ToUnixTimeSecondsQ b
(b c
)c d
)d e
. 
AddClaim $
($ %
$str% -
,- .
userId/ 5
)5 6
. 
Encode "
(" #
)# $
;$ %
return 
token 
; 
} 	
public 
static 
string 
CheckJWT %
(% &
string& ,
jwt- 0
)0 1
{ 	
string 
json 
; 
try 
{ 
IJsonSerializer 

serializer  *
=+ ,
new- 0
JsonNetSerializer1 B
(B C
)C D
;D E
var 
provider 
= 
new "
UtcDateTimeProvider# 6
(6 7
)7 8
;8 9
IJwtValidator   
	validator   '
=  ( )
new  * -
JwtValidator  . :
(  : ;

serializer  ; E
,  E F
provider  G O
)  O P
;  P Q
IBase64UrlEncoder!! !

urlEncoder!!" ,
=!!- .
new!!/ 2
JwtBase64UrlEncoder!!3 F
(!!F G
)!!G H
;!!H I
IJwtAlgorithm"" 
	algorithm"" '
=""( )
new""* -
HMACSHA256Algorithm"". A
(""A B
)""B C
;""C D
IJwtDecoder## 
decoder## #
=##$ %
new##& )

JwtDecoder##* 4
(##4 5

serializer##5 ?
,##? @
	validator##A J
,##J K

urlEncoder##L V
,##V W
	algorithm##X a
)##a b
;##b c
json$$ 
=$$ 
decoder$$ 
.$$ 
Decode$$ %
($$% &
jwt$$& )
,$$) *
$str$$+ U
,$$U V
verify$$W ]
:$$] ^
true$$_ c
)$$c d
;$$d e
}%% 
catch&& 
(&& !
TokenExpiredException&& (
)&&( )
{'' 
return(( 
$str(( *
;((* +
})) 
catch** 
(** *
SignatureVerificationException** 1
)**1 2
{++ 
return,, 
$str,, 4
;,,4 5
}-- 
return.. 
json.. 
;.. 
}// 	
public11 
static11 
bool11 

IsValidJWT11 %
(11% &
string11& ,
jwt11- 0
)110 1
{22 	
if33 
(33 
jwt33 
==33 
$str33 )
||33* ,
jwt33- 0
==331 3
$str334 Q
)33Q R
{44 
return55 
false55 
;55 
}66 
return77 
true77 
;77 
}88 	
public:: 
static:: 
int:: 
ExtractUserId:: '
(::' (
string::( .
jwt::/ 2
)::2 3
{;; 	
string<< 
claims<< 
=<< 
jwt<< 
.<<  
Split<<  %
(<<% &
$char<<& )
)<<) *
.<<* +
ToList<<+ 1
(<<1 2
)<<2 3
[<<3 4
$num<<4 5
]<<5 6
.<<6 7
Split<<7 <
(<<< =
$char<<= @
)<<@ A
.<<A B
ToList<<B H
(<<H I
)<<I J
[<<J K
$num<<K L
]<<L M
;<<M N
string== 
id== 
=== 
claims== 
.== 
Remove== %
(==% &
claims==& ,
.==, -
Length==- 3
-==4 5
$num==6 7
)==7 8
;==8 9
return>> 
Int32>> 
.>> 
Parse>> 
(>> 
id>> !
)>>! "
;>>" #
}?? 	
}@@ 
}AA æ
zC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Utils\MailSystem.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Utils% *
{ 
public 

static 
class 

MailSystem "
{ 
public 
static 
string 
email "
=# $
$str% C
;C D
public		 
static		 
string		 
password		 %
=		& '
$str		( 8
;		8 9
public

 
static

 
void

  
SendRegistrationMail

 /
(

/ 0
string

0 6
userMail

7 ?
,

? @
string

A G
username

H P
)

P Q
{ 	
string 
body 
= 
$" 
$str "
{" #
username# +
}+ ,
$str	, ª
"
ª º
;
º Ω
MailMessage 
mail 
= 
new "
MailMessage# .
(. /
email/ 4
,4 5
userMail6 >
)> ?
;? @
mail 
. 
Subject 
= 
$str )
;) *
mail 
. 
Body 
= 
body 
; 
using 
( 
var 

smtpClient !
=" #
new$ '

SmtpClient( 2
(2 3
)3 4
)4 5
{ 

smtpClient 
. !
UseDefaultCredentials 0
=1 2
false3 8
;8 9

smtpClient 
. 
Credentials &
=' (
new) ,
NetworkCredential- >
(> ?
email? D
,D E
passwordF N
)N O
;O P

smtpClient 
. 
Host 
=  !
$str" 2
;2 3

smtpClient 
. 
Port 
=  !
$num" %
;% &

smtpClient 
. 
	EnableSsl $
=% &
true' +
;+ ,

smtpClient 
. 
DeliveryMethod )
=* +
SmtpDeliveryMethod, >
.> ?
Network? F
;F G

smtpClient 
. 
Send 
(  
mail  $
)$ %
;% &
} 
} 	
} 
} ú
tC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Utils\Role.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Utils% *
{ 
public 

enum 
Role 
{ 
Guest 
, 
Admin 
, 
Staff 
} 
}		 