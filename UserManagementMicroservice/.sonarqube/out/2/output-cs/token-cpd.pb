⁄û
ÖC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Controllers\UsersController.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Controllers% 0
{ 
[ 
Route 

(
 
$str 
) 
] 
[ 
ApiController 
] 
public 

class 
UsersController  
:! "
ControllerBase# 1
{ 
private 
readonly 
IUsersRepository )
_repository* 5
;5 6
[ 	)
ActivatorUtilitiesConstructor	 &
]& '
public 
UsersController 
( 
IUsersRepository /

repository0 :
): ;
{ 	
_repository 
= 

repository $
;$ %
} 	
public 
UsersController 
( 
)  
{ 	
}   	
[!! 	
HttpGet!!	 
]!! 
public"" 
async"" 
Task"" 
<"" 
IActionResult"" '
>""' (
GetAllAsync"") 4
(""4 5
[""5 6

FromHeader""6 @
]""@ A
string""B H
authorizationToken""I [
)""[ \
{## 	
var$$ 
result$$ 
=$$ 
	CheckAuth$$  
($$  !
authorizationToken$$! 3
)$$3 4
as$$5 7
ObjectResult$$8 D
;$$D E
var%% 
response%% 
=%% 
await%%  
_repository%%! ,
.%%, -
GetAllAsync%%- 8
(%%8 9
Jwt%%9 <
.%%< =
ExtractUserId%%= J
(%%J K
result%%K Q
.%%Q R
Value%%R W
.%%W X
ToString%%X `
(%%` a
)%%a b
)%%b c
)%%c d
;%%d e
if&& 
(&& 
response&& 
==&& 
null&&  
)&&  !
{'' 
return(( 
Unauthorized(( #
(((# $
new(($ '
Error((( -
(((- .
$str((. I
)((I J
)((J K
;((K L
})) 
return** 
Ok** 
(** 
response** 
)** 
;**  
}++ 	
[-- 	
HttpGet--	 
(-- 
$str-- 
,-- 
Name-- 
=-- 
$str--  )
)--) *
]--* +
public.. 
async.. 
Task.. 
<.. 
User.. 
>.. 
GetById..  '
(..' (
int..( +
id.., .
)... /
=>..0 2
await..3 8
_repository..9 D
...D E
GetByIdAsync..E Q
(..Q R
id..R T
)..T U
;..U V
[00 	
Route00	 
(00 
$str00 
)00 
]00  
[11 	
HttpGet11	 
]11 
public33 
IActionResult33 
	CheckAuth33 &
(33& '
[33' (

FromHeader33( 2
]332 3
string334 :
authorizationToken33; M
)33M N
{44 	
var55 
result55 
=55 
Jwt55 
.55 
CheckJWT55 %
(55% &
authorizationToken55& 8
)558 9
;559 :
if66 
(66 
!66 
Jwt66 
.66 

IsValidJWT66 
(66  
result66  &
)66& '
)66' (
{77 
return88 
Unauthorized88 #
(88# $
new88$ '
Error88( -
(88- .
result88. 4
)884 5
)885 6
;886 7
}99 
return:: 
Ok:: 
(:: 
result:: 
):: 
;:: 
};; 	
[== 	
Route==	 
(== 
$str==  
)==  !
]==! "
[>> 	
HttpGet>>	 
]>> 
public?? 
async?? 
Task?? 
<?? 
IActionResult?? '
>??' (!
VerifyAdminPrivileges??) >
(??> ?
string??? E
json??F J
)??J K
{@@ 	
varAA 
resultAA 
=AA 
awaitAA 
_repositoryAA *
.AA* +
HasAdminPrivilegesAA+ =
(AA= >
JwtAA> A
.AAA B
ExtractUserIdAAB O
(AAO P
jsonAAP T
)AAT U
)AAU V
;AAV W
ifBB 
(BB 
!BB 
resultBB 
)BB 
{CC 
returnDD 
UnauthorizedDD #
(DD# $
newDD$ '
ErrorDD( -
(DD- .
$strDD. I
)DDI J
)DDJ K
;DDK L
}EE 
returnFF 
OkFF 
(FF 
resultFF 
)FF 
;FF 
}GG 	
[II 	
RouteII	 
(II 
$strII 
)II 
]II 
[JJ 	
HttpGetJJ	 
]JJ 
publicKK 
asyncKK 
TaskKK 
<KK 
IActionResultKK '
>KK' (
GetByIdAsyncKK) 5
(KK5 6
[KK6 7

FromHeaderKK7 A
]KKA B
stringKKC I
authorizationTokenKKJ \
)KK\ ]
{LL 	
varMM 
resultMM 
=MM 
	CheckAuthMM "
(MM" #
authorizationTokenMM# 5
)MM5 6
asMM7 9
ObjectResultMM: F
;MMF G
ifNN 
(NN 
resultNN 
isNN $
UnauthorizedObjectResultNN 1
)NN1 2
{OO 
returnPP 
resultPP 
;PP 
}QQ 
varRR 
responseRR 
=RR 
awaitRR  
_repositoryRR! ,
.RR, -
GetByIdAsyncRR- 9
(RR9 :
JwtRR: =
.RR= >
ExtractUserIdRR> K
(RRK L
resultRRL R
.RRR S
ValueRRS X
.RRX Y
ToStringRRY a
(RRa b
)RRb c
)RRc d
)RRd e
;RRe f
returnSS 
OkSS 
(SS 
responseSS 
)SS 
;SS  
}TT 	
[VV 	
RouteVV	 
(VV 
$strVV 
)VV 
]VV 
[WW 	
HttpGetWW	 
]WW 
publicXX 
asyncXX 
TaskXX 
<XX 
IActionResultXX '
>XX' (
GetUsernameAsyncXX) 9
(XX9 :
[XX: ;

FromHeaderXX; E
]XXE F
stringXXG M
authorizationTokenXXN `
)XX` a
{YY 	
varZZ 
resultZZ 
=ZZ 
	CheckAuthZZ "
(ZZ" #
authorizationTokenZZ# 5
)ZZ5 6
asZZ7 9
ObjectResultZZ: F
;ZZF G
if[[ 
([[ 
result[[ 
is[[ $
UnauthorizedObjectResult[[ 2
)[[2 3
{\\ 
return]] 
result]] 
;]] 
}^^ 
var__ 
user__ 
=__ 
await__ 
_repository__ (
.__( )
GetByIdAsync__) 5
(__5 6
Jwt__6 9
.__9 :
ExtractUserId__: G
(__G H
result__H N
.__N O
Value__O T
.__T U
ToString__U ]
(__] ^
)__^ _
)___ `
)__` a
;__a b
if`` 
(`` 
user`` 
==`` 
null`` 
)`` 
{aa 
returnbb 
NotFoundbb 
(bb  
newbb  #
Errorbb$ )
(bb) *
$strbb* ?
)bb? @
)bb@ A
;bbA B
}cc 
returndd 
Okdd 
(dd 
JsonConvertdd !
.dd! "
SerializeObjectdd" 1
(dd1 2
newdd2 5
{dd6 7
usernamedd8 @
=ddA B
userddC G
.ddG H
UsernameddH P
}ddQ R
)ddR S
)ddS T
;ddT U
}ee 	
[gg 	
Routegg	 
(gg 
$strgg 
)gg 
]gg 
[hh 	
HttpPosthh	 
]hh 
publicii 
asyncii 
Taskii 
<ii 
IActionResultii '
>ii' (
RegisterAsyncii) 6
(ii6 7
UserRegisterDtoii7 F
userRegisteriiG S
,iiS T
intiiT W
roleiiX \
)ii\ ]
{jj 	
varkk 
resultkk 
=kk 
awaitkk 
_repositorykk *
.kk* +
RegisterAsynckk+ 8
(kk8 9
userRegisterkk9 E
,kkE F
rolekkG K
)kkK L
;kkL M
ifll 
(ll 
resultll 
==ll 
-ll 
$numll 
)ll 
{mm 
returnnn 
Conflictnn 
(nn  
newnn  #
Errornn$ )
(nn) *
$strnn* @
)nn@ A
)nnA B
;nnB C
}oo 
ifpp 
(pp 
resultpp 
==pp 
-pp 
$numpp 
)pp 
{qq 
returnrr 
Conflictrr 
(rr  
newrr  #
Errorrr$ )
(rr) *
$strrr* C
)rrC D
)rrD E
;rrE F
}ss 
returntt 
Oktt 
(tt 
resulttt 
)tt 
;tt 
}uu 	
[xx 	
Routexx	 
(xx 
$strxx 
)xx  
]xx  !
[yy 	
HttpPostyy	 
]yy 
publiczz 
asynczz 
Taskzz 
<zz 
IActionResultzz '
>zz' (
RegisterGuestAsynczz) ;
(zz; <
[zz< =
FromBodyzz= E
]zzE F
UserRegisterDtozzG V
userRegisterzzW c
)zzc d
{{{ 	
var|| 
result|| 
=|| 
await|| 
RegisterAsync|| ,
(||, -
userRegister||- 9
,||9 :
$num||; <
)||< =
;||= >
return}} 
CreatedAtAction}} "
(}}" #
nameof}}# )
(}}) *
GetById}}* 1
)}}1 2
,}}2 3
new}}4 7
{}}8 9
id}}: <
=}}= >
result}}? E
}}}F G
,}}G H
userRegister}}I U
)}}U V
;}}V W
}~~ 	
[
ÄÄ 	
Route
ÄÄ	 
(
ÄÄ 
$str
ÄÄ 
)
ÄÄ  
]
ÄÄ  !
[
ÅÅ 	
HttpPost
ÅÅ	 
]
ÅÅ 
public
ÇÇ 
async
ÇÇ 
Task
ÇÇ 
<
ÇÇ 
IActionResult
ÇÇ '
>
ÇÇ' ( 
RegisterAdminAsync
ÇÇ) ;
(
ÇÇ; <
[
ÇÇ< =

FromHeader
ÇÇ= G
]
ÇÇG H
string
ÇÇI O 
authorizationToken
ÇÇP b
,
ÇÇb c
[
ÇÇd e
FromBody
ÇÇe m
]
ÇÇm n
UserRegisterDto
ÇÇo ~
userRegisterÇÇ ã
)ÇÇã å
{
ÉÉ 	
var
ÑÑ 
jsonObjectResult
ÑÑ  
=
ÑÑ! "
	CheckAuth
ÑÑ# ,
(
ÑÑ, - 
authorizationToken
ÑÑ- ?
)
ÑÑ? @
as
ÑÑA C
ObjectResult
ÑÑD P
;
ÑÑP Q
if
ÖÖ 
(
ÖÖ 
jsonObjectResult
ÖÖ  
is
ÖÖ! #&
UnauthorizedObjectResult
ÖÖ$ <
)
ÖÖ< =
{
ÜÜ 
return
áá 
jsonObjectResult
áá '
;
áá' (
}
àà 
var
ââ 

priviliges
ââ 
=
ââ 
await
ââ "#
VerifyAdminPrivileges
ââ# 8
(
ââ8 9
jsonObjectResult
ââ9 I
.
ââI J
Value
ââJ O
.
ââO P
ToString
ââP X
(
ââX Y
)
ââY Z
)
ââZ [
;
ââ[ \
if
ää 
(
ää 

priviliges
ää 
is
ää &
UnauthorizedObjectResult
ää 6
)
ää6 7
{
ãã 
return
åå 

priviliges
åå !
;
åå! "
}
çç 
var
éé 
result
éé 
=
éé 
await
éé 
RegisterAsync
éé ,
(
éé, -
userRegister
éé- 9
,
éé9 :
$num
éé; <
)
éé< =
;
éé= >
return
èè 
CreatedAtAction
èè "
(
èè" #
nameof
èè# )
(
èè) *
GetById
èè* 1
)
èè1 2
,
èè2 3
new
èè4 7
{
èè8 9
id
èè: <
=
èè= >
result
èè? E
}
èèF G
,
èèG H
userRegister
èèI U
)
èèU V
;
èèV W
}
êê 	
[
íí 	
Route
íí	 
(
íí 
$str
íí 
)
íí  
]
íí  !
[
ìì 	
HttpPost
ìì	 
]
ìì 
public
îî 
async
îî 
Task
îî 
<
îî 
IActionResult
îî '
>
îî' ( 
RegisterStaffAsync
îî) ;
(
îî; <
[
îî< =

FromHeader
îî= G
]
îîG H
string
îîI O 
authorizationToken
îîP b
,
îîb c
[
îîd e
FromBody
îîe m
]
îîm n
UserRegisterDto
îîo ~
userRegisterîî ã
)îîã å
{
ïï 	
var
ññ 
jsonObjectResult
ññ  
=
ññ! "
	CheckAuth
ññ# ,
(
ññ, - 
authorizationToken
ññ- ?
)
ññ? @
as
ññA C
ObjectResult
ññD P
;
ññP Q
if
óó 
(
óó 
jsonObjectResult
óó  
is
óó! #&
UnauthorizedObjectResult
óó$ <
)
óó< =
{
òò 
return
ôô 
jsonObjectResult
ôô '
;
ôô' (
}
öö 
var
õõ 

priviliges
õõ 
=
õõ 
await
õõ "#
VerifyAdminPrivileges
õõ# 8
(
õõ8 9
jsonObjectResult
õõ9 I
.
õõI J
Value
õõJ O
.
õõO P
ToString
õõP X
(
õõX Y
)
õõY Z
)
õõZ [
;
õõ[ \
if
úú 
(
úú 

priviliges
úú 
is
úú &
UnauthorizedObjectResult
úú 6
)
úú6 7
{
ùù 
return
ûû 

priviliges
ûû !
;
ûû! "
}
üü 
var
†† 
result
†† 
=
†† 
await
†† 
RegisterAsync
†† ,
(
††, -
userRegister
††- 9
,
††9 :
$num
††; <
)
††< =
;
††= >
return
°° 
CreatedAtAction
°° "
(
°°" #
nameof
°°# )
(
°°) *
GetById
°°* 1
)
°°1 2
,
°°2 3
new
°°4 7
{
°°8 9
id
°°: <
=
°°= >
result
°°? E
}
°°F G
,
°°G H
userRegister
°°I U
)
°°U V
;
°°V W
}
¢¢ 	
[
§§ 	
Route
§§	 
(
§§ 
$str
§§ 
)
§§ 
]
§§ 
[
•• 	
HttpPost
••	 
]
•• 
public
¶¶ 
async
¶¶ 
Task
¶¶ 
<
¶¶ 
IActionResult
¶¶ '
>
¶¶' (

LoginAsync
¶¶) 3
(
¶¶3 4
[
¶¶4 5
FromBody
¶¶5 =
]
¶¶= > 
UserCredentialsDto
¶¶? Q
userCredentials
¶¶R a
)
¶¶a b
{
ßß 	
var
®® 
user
®® 
=
®® 
await
®® 
_repository
®® (
.
®®( )

LoginAsync
®®) 3
(
®®3 4
userCredentials
®®4 C
)
®®C D
;
®®D E
if
©© 
(
©© 
user
©© 
==
©© 
null
©© 
)
©© 
{
™™ 
return
´´ 

BadRequest
´´ !
(
´´! "
new
´´" %
Error
´´& +
(
´´+ ,
$str
´´, G
)
´´G H
)
´´H I
;
´´I J
}
¨¨ 
string
≠≠ 
userRole
≠≠ 
=
≠≠ 
(
≠≠ 
(
≠≠  
Role
≠≠  $
)
≠≠$ %
user
≠≠% )
.
≠≠) *
Role
≠≠* .
)
≠≠. /
.
≠≠/ 0
ToString
≠≠0 8
(
≠≠8 9
)
≠≠9 :
;
≠≠: ;
return
ÆÆ 
Ok
ÆÆ 
(
ÆÆ 
JsonConvert
ÆÆ !
.
ÆÆ! "
SerializeObject
ÆÆ" 1
(
ÆÆ1 2
new
ÆÆ2 5
{
ÆÆ6 7
jwt
ÆÆ8 ;
=
ÆÆ< =
Jwt
ÆÆ> A
.
ÆÆA B
	CreateJWT
ÆÆB K
(
ÆÆK L
user
ÆÆL P
.
ÆÆP Q
Id
ÆÆQ S
,
ÆÆS T
$num
ÆÆU V
)
ÆÆV W
,
ÆÆW X
role
ÆÆY ]
=
ÆÆ^ _
userRole
ÆÆ` h
}
ÆÆi j
)
ÆÆj k
)
ÆÆk l
;
ÆÆl m
}
±± 	
[
≥≥ 	
HttpPut
≥≥	 
]
≥≥ 
public
¥¥ 
async
¥¥ 
Task
¥¥ 
<
¥¥ 
IActionResult
¥¥ '
>
¥¥' (
UpdateAsync
¥¥) 4
(
¥¥4 5
[
¥¥5 6
FromBody
¥¥6 >
]
¥¥> ?
UserRegisterDto
¥¥@ O
user
¥¥P T
,
¥¥T U
[
¥¥U V

FromHeader
¥¥V `
]
¥¥` a
string
¥¥b h 
authorizationToken
¥¥i {
)
¥¥{ |
{
µµ 	
var
∂∂ 
result
∂∂ 
=
∂∂ 
	CheckAuth
∂∂ "
(
∂∂" # 
authorizationToken
∂∂# 5
)
∂∂5 6
as
∂∂7 9
ObjectResult
∂∂: F
;
∂∂F G
if
∑∑ 
(
∑∑ 
result
∑∑ 
is
∑∑ &
UnauthorizedObjectResult
∑∑ 2
)
∑∑2 3
{
∏∏ 
return
ππ 
result
ππ 
;
ππ 
}
∫∫ 
bool
ªª 
	isUpdated
ªª 
=
ªª 
await
ªª "
_repository
ªª# .
.
ªª. /
UpdateAsync
ªª/ :
(
ªª: ;
user
ªª; ?
,
ªª? @
Jwt
ªªA D
.
ªªD E
ExtractUserId
ªªE R
(
ªªR S
result
ªªS Y
.
ªªY Z
Value
ªªZ _
.
ªª_ `
ToString
ªª` h
(
ªªh i
)
ªªi j
)
ªªj k
)
ªªk l
;
ªªl m
if
ºº 
(
ºº 
!
ºº 
	isUpdated
ºº 
)
ºº 
{
ΩΩ 
return
ææ 
NotFound
ææ 
(
ææ  
new
ææ  #
Error
ææ$ )
(
ææ) *
$str
ææ* >
)
ææ> ?
)
ææ? @
;
ææ@ A
}
øø 
return
¿¿ 
	NoContent
¿¿ 
(
¿¿ 
)
¿¿ 
;
¿¿ 
}
¡¡ 	
[
√√ 	

HttpDelete
√√	 
]
√√ 
public
ƒƒ 
async
ƒƒ 
Task
ƒƒ 
<
ƒƒ 
IActionResult
ƒƒ '
>
ƒƒ' (
DeleteAsync
ƒƒ) 4
(
ƒƒ4 5
[
ƒƒ5 6

FromHeader
ƒƒ6 @
]
ƒƒ@ A
string
ƒƒB H 
authorizationToken
ƒƒI [
)
ƒƒ[ \
{
≈≈ 	
var
∆∆ 
result
∆∆ 
=
∆∆ 
	CheckAuth
∆∆ "
(
∆∆" # 
authorizationToken
∆∆# 5
)
∆∆5 6
as
∆∆7 9
ObjectResult
∆∆: F
;
∆∆F G
if
«« 
(
«« 
result
«« 
is
«« &
UnauthorizedObjectResult
«« 2
)
««2 3
{
»» 
return
…… 
result
…… 
;
…… 
}
   
await
ÀÀ 
_repository
ÀÀ 
.
ÀÀ 
DeleteByIdAsync
ÀÀ -
(
ÀÀ- .
Jwt
ÀÀ. 1
.
ÀÀ1 2
ExtractUserId
ÀÀ2 ?
(
ÀÀ? @
result
ÀÀ@ F
.
ÀÀF G
Value
ÀÀG L
.
ÀÀL M
ToString
ÀÀM U
(
ÀÀU V
)
ÀÀV W
)
ÀÀW X
)
ÀÀX Y
;
ÀÀY Z
return
ÃÃ 
	NoContent
ÃÃ 
(
ÃÃ 
)
ÃÃ 
;
ÃÃ 
}
ŒŒ 	
}
–– 
}—— ˙

zC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Data\DataContext.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Data% )
{ 
public 

class 
DataContext 
: 
	DbContext (
{ 
public		 
DataContext		 
(		 
DbContextOptions		 +
options		, 3
)		3 4
:		5 6
base		7 ;
(		; <
options		< C
)		C D
{

 	
} 	
public 
DbSet 
< 
User 
> 
Users  
{! "
get# &
;& '
set( +
;+ ,
}- .
	protected 
override 
void 
OnModelCreating  /
(/ 0
ModelBuilder0 <
modelBuilder= I
)I J
{ 	
modelBuilder 
. 
Entity 
<  
User  $
>$ %
(% &
)& '
. 
Property !
(! "
user" &
=>' )
user* .
.. /
Id/ 1
)1 2
. 
ValueGeneratedOnAdd ,
(, -
)- .
;. /
} 	
} 
} »
C:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Data\IUsersRepository.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Data% )
{ 
public		 

	interface		 
IUsersRepository		 %
{

 
Task 
< 
int 
> 
RegisterAsync 
(  
UserRegisterDto  /
userRegister0 <
,< =
int> A
roleB F
)F G
;G H
Task 
< 
User 
> 

LoginAsync 
( 
UserCredentialsDto 0
userCredentials1 @
)@ A
;A B
Task 
< 
IEnumerable 
< 
User 
> 
> 
GetAllAsync  +
(+ ,
int, /
userId0 6
)6 7
;7 8
Task 
< 
User 
> 
GetByIdAsync 
(  
int  #
userId$ *
)* +
;+ ,
Task 
< 
bool 
> 
UpdateAsync 
( 
UserRegisterDto .
user/ 3
,3 4
int5 8
userId9 ?
)? @
;@ A
Task 
DeleteByIdAsync 
( 
int  
userId! '
)' (
;( )
Task 
< 
bool 
> 
HasAdminPrivileges %
(% &
int& )
userId* 0
)0 1
;1 2
} 
} ÷
ñC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Data\Migrations\20210420162254_InitialCreate.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Data% )
.) *

Migrations* 4
{ 
public 

partial 
class 
InitialCreate &
:' (
	Migration) 2
{ 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder		 
.		 
CreateTable		 (
(		( )
name

 
:

 
$str

 
,

 
columns 
: 
table 
=> !
new" %
{ 
Id 
= 
table 
. 
Column %
<% &
int& )
>) *
(* +
type+ /
:/ 0
$str1 :
,: ;
nullable< D
:D E
falseF K
)K L
. 

Annotation #
(# $
$str$ :
,: ;
true< @
)@ A
,A B
Username 
= 
table $
.$ %
Column% +
<+ ,
string, 2
>2 3
(3 4
type4 8
:8 9
$str: @
,@ A
nullableB J
:J K
trueL P
)P Q
,Q R
Email 
= 
table !
.! "
Column" (
<( )
string) /
>/ 0
(0 1
type1 5
:5 6
$str7 =
,= >
nullable? G
:G H
trueI M
)M N
,N O
Password 
= 
table $
.$ %
Column% +
<+ ,
string, 2
>2 3
(3 4
type4 8
:8 9
$str: @
,@ A
nullableB J
:J K
trueL P
)P Q
,Q R
Role 
= 
table  
.  !
Column! '
<' (
int( +
>+ ,
(, -
type- 1
:1 2
$str3 <
,< =
nullable> F
:F G
falseH M
)M N
} 
, 
constraints 
: 
table "
=># %
{ 
table 
. 

PrimaryKey $
($ %
$str% /
,/ 0
x1 2
=>3 5
x6 7
.7 8
Id8 :
): ;
;; <
} 
) 
; 
} 	
	protected 
override 
void 
Down  $
($ %
MigrationBuilder% 5
migrationBuilder6 F
)F G
{ 	
migrationBuilder 
. 
	DropTable &
(& '
name 
: 
$str 
) 
; 
} 	
} 
}   ö
sC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Data\Role.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Data% )
{ 
public 

enum 
Role 
{		 
Guest

 
,

 
Admin 
, 
Staff 
} 
} »H
~C:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Data\UsersRepository.cs
	namespace

 	&
UserManagementMicroservice


 $
.

$ %
Data

% )
{ 
public 

class 
UsersRepository  
:! "
IUsersRepository# 3
{ 
private 
readonly 
DataContext $
context% ,
;, -
public 
UsersRepository 
( 
DataContext *
context+ 2
)2 3
{ 	
this 
. 
context 
= 
context "
;" #
} 	
public 
async 
Task 
< 
int 
> 
RegisterAsync ,
(, -
UserRegisterDto- <
userRegister= I
,I J
intK N
roleO S
)S T
{ 	
if 
( 
this 
. 
context 
. 
Users !
.! "
Any" %
(% &
user& *
=>+ -
user. 2
.2 3
Username3 ;
==< >
userRegister? K
.K L
UsernameL T
)T U
)U V
{ 
return 
- 
$num 
; 
} 
if 
( 
this 
. 
context 
. 
Users !
.! "
Any" %
(% &
user& *
=>+ -
user. 2
.2 3
Email3 8
==9 ;
Cryptography< H
.H I

HashStringI S
(S T
userRegisterT `
.` a
Emaila f
)f g
)g h
)h i
{ 
return 
- 
$num 
; 
} 
User 
registerUser 
= 
new "
(" #
userRegister# /
./ 0
Username0 8
,8 9
userRegister: F
.F G
EmailG L
,L M
userRegisterN Z
.Z [
Password[ c
,c d
rolee i
)i j
;j k
var   
user   
=   
this   
.   
context   #
.  # $
Add  $ '
(  ' (
Cryptography  ( 4
.  4 5
HashUserData  5 A
(  A B
registerUser  B N
)  N O
)  O P
;  P Q
await!! 
this!! 
.!! 
context!! 
.!! 
SaveChangesAsync!! /
(!!/ 0
)!!0 1
;!!1 2
return"" 
user"" 
."" 
Entity"" 
."" 
Id"" !
;""! "
}## 	
public%% 
async%% 
Task%% 
<%% 
User%% 
>%% 

LoginAsync%%  *
(%%* +
UserCredentialsDto%%+ =
userCredentials%%> M
)%%M N
{&& 	
var'' 
user'' 
='' 
await'' 
this'' !
.''! "
context''" )
.'') *
Users''* /
.''/ 0
Where''0 5
(''5 6
user''6 :
=>''; =
user''> B
.''B C
Email''C H
==''I K
Cryptography''L X
.''X Y

HashString''Y c
(''c d
userCredentials''d s
.''s t
Email''t y
)''y z
&&((* ,
user((- 1
.((1 2
Password((2 :
==((; =
Cryptography((> J
.((J K

HashString((K U
(((U V
userCredentials((V e
.((e f
Password((f n
)((n o
)((o p
.((p q 
FirstOrDefaultAsync	((q Ñ
(
((Ñ Ö
)
((Ö Ü
;
((Ü á
if)) 
()) 
user)) 
==)) 
null)) 
))) 
{** 
return++ 
null++ 
;++ 
},, 
return-- 
user-- 
;-- 
}// 	
public11 
async11 
Task11 
<11 
bool11 
>11 
UpdateAsync11  +
(11+ ,
UserRegisterDto11, ;
user11< @
,11@ A
int11B E
userId11F L
)11L M
{22 	
var33
 
result33 
=33 
this33 
.33 
context33 #
.33# $
Users33$ )
.33) *
Find33* .
(33. /
userId33/ 5
)335 6
;336 7
if44
 
(44 
result44 
==44 
null44 
)44 
{55 
return66 
false66 
;66 
}77 
result88
 
.88 
Username88 
=88 
user88  
.88  !
Username88! )
??88* ,
result88- 3
.883 4
Username884 <
;88< =
result99
 
.99 
Email99 
=99 
Cryptography99 %
.99% &

HashString99& 0
(990 1
user991 5
.995 6
Email996 ;
)99; <
??99= ?
result99@ F
.99F G
Email99G L
;99L M
result::
 
.:: 
Password:: 
=:: 
Cryptography:: (
.::( )

HashString::) 3
(::3 4
user::4 8
.::8 9
Password::9 A
)::A B
??::C E
result::F L
.::L M
Password::M U
;::U V
await;;
 
this;; 
.;; 
context;; 
.;; 
SaveChangesAsync;; -
(;;- .
);;. /
;;;/ 0
return<<
 
true<< 
;<< 
}== 	
public?? 
async?? 
Task?? 
<?? 
IEnumerable?? %
<??% &
User??& *
>??* +
>??+ ,
GetAllAsync??- 8
(??8 9
int??9 <
userId??= C
)??C D
{@@ 	
varAA 
resultAA 
=AA 
awaitAA 
thisAA #
.AA# $
contextAA$ +
.AA+ ,
UsersAA, 1
.AA1 2
	FindAsyncAA2 ;
(AA; <
userIdAA< B
)AAB C
;AAC D
ifBB 
(BB 
resultBB 
==BB 
nullBB 
||BB  
resultBB! '
.BB' (
RoleBB( ,
!=BB- /
$numBB0 1
)BB1 2
{CC 
returnDD 
nullDD 
;DD 
}EE 
returnFF 
awaitFF 
thisFF 
.FF 
contextFF %
.FF% &
UsersFF& +
.FF+ ,
ToListAsyncFF, 7
(FF7 8
)FF8 9
;FF9 :
}GG 	
publicII 
asyncII 
TaskII 
<II 
UserII 
>II 
GetByIdAsyncII  ,
(II, -
intII- 0
userIdII1 7
)II7 8
{JJ 	
returnKK 
awaitKK 
thisKK 
.KK 
contextKK %
.KK% &
UsersKK& +
.KK+ ,
	FindAsyncKK, 5
(KK5 6
userIdKK6 <
)KK< =
;KK= >
}LL 	
publicNN 
asyncNN 
TaskNN 
DeleteByIdAsyncNN )
(NN) *
intNN* -
userIdNN. 4
)NN4 5
{OO 	
varPP 
userPP 
=PP 
awaitPP 
thisPP !
.PP! "
contextPP" )
.PP) *
UsersPP* /
.PP/ 0
	FindAsyncPP0 9
(PP9 :
userIdPP: @
)PP@ A
;PPA B
thisQQ 
.QQ 
contextQQ 
.QQ 
RemoveQQ 
(QQ  
userQQ  $
)QQ$ %
;QQ% &
awaitRR 
thisRR 
.RR 
contextRR 
.RR 
SaveChangesAsyncRR /
(RR/ 0
)RR0 1
;RR1 2
}TT 	
publicUU 
asyncUU 
TaskUU 
<UU 
boolUU 
>UU 
HasAdminPrivilegesUU  2
(UU2 3
intUU3 6
userIdUU7 =
)UU= >
{VV 	
varWW 
userWW 
=WW 
awaitWW 
thisWW !
.WW! "
contextWW" )
.WW) *
UsersWW* /
.WW/ 0
	FindAsyncWW0 9
(WW9 :
userIdWW: @
)WW@ A
;WWA B
ifXX 
(XX 
userXX 
==XX 
nullXX 
)XX 
{YY 
returnZZ 
falseZZ 
;ZZ 
}[[ 
if\\ 
(\\ 
user\\ 
.\\ 
Role\\ 
==\\ 
$num\\ 
)\\ 
{]] 
return^^ 
true^^ 
;^^ 
}__ 
return`` 
false`` 
;`` 
}aa 	
}bb 
}cc ñ
ÅC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\DTOs\UserCredentialsDto.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
DTOs% )
{ 
public 

class 
UserCredentialsDto #
{ 
public 
string 
Email 
{ 
get !
;! "
set# &
;& '
}( )
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
} 
}		 ´
~C:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\DTOs\UserRegisterDto.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
DTOs% )
{ 
public 

class 
UserRegisterDto  
{ 
public 
string 
Username 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 
Email 
{ 
get !
;! "
set# &
;& '
}( )
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
}		 
}

 –
wC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Entities\User.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Entities% -
{ 
public 

class 
User 
{ 
public 
User 
( 
) 
{ 	
} 	
public		 
User		 
(		 
string		 
username		 #
,		# $
string		% +
email		, 1
,		1 2
string		3 9
password		: B
,		B C
int		C F
role		G K
)		K L
{

 	
Username 
= 
username 
;  
Email 
= 
email 
; 
Password 
= 
password 
;  
Role 
= 
role 
; 
} 	
public 
User 
( 
int 
Id 
, 
string "
username# +
,+ ,
string- 3
email4 9
,9 :
string; A
passwordB J
)J K
{ 	
this 
. 
Id 
= 
Id 
; 
Username 
= 
username 
;  
Email 
= 
email 
; 
Password 
= 
password 
;  
} 	
public 
int 
Id 
{ 
get 
; 
set  
;  !
}" #
public 
string 
Username 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
string 
Email 
{ 
get !
;! "
set# &
;& '
}( )
public 
string 
Password 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
int 
Role 
{ 
get 
; 
set "
;" #
}$ %
} 
}   Ì

qC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Program.cs
	namespace 	&
UserManagementMicroservice
 $
{ 
public 

static 
class 
Program 
{ 
public 
static 
void 
Main 
(  
string  &
[& '
]' (
args) -
)- .
{		 	
CreateHostBuilder

 
(

 
args

 "
)

" #
.

# $
Build

$ )
(

) *
)

* +
.

+ ,
Run

, /
(

/ 0
)

0 1
;

1 2
} 	
public 
static 
IHostBuilder "
CreateHostBuilder# 4
(4 5
string5 ;
[; <
]< =
args> B
)B C
=>D F
Host 
.  
CreateDefaultBuilder %
(% &
args& *
)* +
. $
ConfigureWebHostDefaults )
() *

webBuilder* 4
=>5 7
{ 

webBuilder 
. 

UseStartup )
<) *
Startup* 1
>1 2
(2 3
)3 4
;4 5
} 
) 
; 
} 
} ∆"
qC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Startup.cs
	namespace

 	&
UserManagementMicroservice


 $
{ 
public 

class 
Startup 
{ 
readonly 
string $
MyAllowedSpecificOrigins 0
=1 2
$str3 J
;J K
public 
Startup 
( 
IConfiguration %
configuration& 3
)3 4
{ 	
Configuration 
= 
configuration )
;) *
} 	
public 
IConfiguration 
Configuration +
{, -
get. 1
;1 2
}3 4
public 
void 
ConfigureServices %
(% &
IServiceCollection& 8
services9 A
)A B
{ 	
services 
. 
AddControllers #
(# $
)$ %
;% &
services 
. 
AddDbContext !
<! "
DataContext" -
>- .
(. /
options/ 6
=>7 9
{ 
options 
. 
	UseSqlite !
(! "
Configuration" /
./ 0
GetConnectionString0 C
(C D
$strD W
)W X
)X Y
;Y Z
} 
) 
; 
services   
.   
AddCors   
(   
options   $
=>  % '
{!! 
options"" 
."" 
	AddPolicy"" !
(""! "$
MyAllowedSpecificOrigins""" :
,"": ;
builder""< C
=>""D F
{## 
builder$$ 
.$$ 
AllowAnyHeader$$ *
($$* +
)$$+ ,
.%% 
AllowAnyMethod%% #
(%%# $
)%%$ %
.&& 
AllowAnyOrigin&& #
(&&# $
)&&$ %
;&&% &
}'' 
)'' 
;'' 
}(( 
)(( 
;(( 
services** 
.** 
AddTransient** !
<**! "
IUsersRepository**" 2
,**2 3
UsersRepository**4 C
>**C D
(**D E
)**E F
;**F G
services++ 
.++ 
AddSwaggerGen++ "
(++" #
c++# $
=>++% '
{,, 
c-- 
.-- 

SwaggerDoc-- 
(-- 
$str-- !
,--! "
new--# &
OpenApiInfo--' 2
{--3 4
Title--5 :
=--; <
$str--= Y
,--Y Z
Version--[ b
=--c d
$str--e i
}--j k
)--k l
;--l m
}.. 
).. 
;.. 
}// 	
public22 
void22 
	Configure22 
(22 
IApplicationBuilder22 1
app222 5
,225 6
IWebHostEnvironment227 J
env22K N
)22N O
{33 	
if44 
(44 
env44 
.44 
IsDevelopment44 !
(44! "
)44" #
)44# $
{55 
app66 
.66 %
UseDeveloperExceptionPage66 -
(66- .
)66. /
;66/ 0
app77 
.77 

UseSwagger77 
(77 
)77  
;77  !
app88 
.88 
UseSwaggerUI88  
(88  !
c88! "
=>88# %
c88& '
.88' (
SwaggerEndpoint88( 7
(887 8
$str888 R
,88R S
$str88T s
)88s t
)88t u
;88u v
}99 
app;; 
.;; 
UseCors;; 
(;; $
MyAllowedSpecificOrigins;; 0
);;0 1
;;;1 2
app== 
.== 

UseRouting== 
(== 
)== 
;== 
app?? 
.?? 
UseAuthorization??  
(??  !
)??! "
;??" #
appAA 
.AA 
UseEndpointsAA 
(AA 
	endpointsAA &
=>AA' )
{BB 
	endpointsCC 
.CC 
MapControllersCC (
(CC( )
)CC) *
;CC* +
}DD 
)DD 
;DD 
}EE 	
}FF 
}GG »
|C:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Utils\Cryptography.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Utils% *
{ 
public 

static 
class 
Cryptography $
{ 
static		 
readonly		 
byte		 
[		 
]		 
salt		 #
=		$ %
{		& '
$num		( ,
,		, -
$num		. 2
,		2 3
$num		4 8
,		8 9
$num		: >
,		> ?
$num		@ D
,		D E
$num		F J
,		J K
$num		L P
,		P Q
$num		R V
,		V W
$num		X \
,		\ ]
$num		^ b
,		b c
$num		d h
,		h i
$num		j n
,		n o
$num		p t
,		t u
$num		v z
,		z {
$num			| Ä
,
		Ä Å
$num
		Ç Ü
}
		á à
;
		à â
public

 
static

 
User

 
HashUserData

 (
(

( )
User

) -
user

. 2
)

2 3
{ 	
User 

userHashed 
= 
new !
(! "
user" &
.& '
Username' /
,/ 0

HashString1 ;
(; <
user< @
.@ A
EmailA F
)F G
,G H

HashStringI S
(S T
userT X
.X Y
PasswordY a
)a b
,b c
userd h
.h i
Rolei m
)m n
;n o
return 

userHashed 
; 
} 	
public 
static 
string 

HashString '
(' (
string( .
	plaintext/ 8
)8 9
{ 	
if 
( 
	plaintext 
== 
null  
)  !
{ 
return 
null 
; 
} 
string 
hashed 
= 
Convert #
.# $
ToBase64String$ 2
(2 3
KeyDerivation3 @
.@ A
Pbkdf2A G
(G H
password 
: 
	plaintext 
, 
salt 
: 
salt 
, 
prf 
: 
KeyDerivationPrf  
.  !
HMACSHA1! )
,) *
iterationCount 
: 
$num  
,  !
numBytesRequested 
: 
$num !
/" #
$num$ %
)% &
)& '
;' (
return 
hashed 
; 
} 	
} 
} Ï
uC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Utils\Error.cs
	namespace 	&
UserManagementMicroservice
 $
.$ %
Utils% *
{ 
public 

class 
Error 
{ 
public 
Error 
( 
string 
errorMessage (
)( )
{ 	
this 
. 
ErrorMessage 
= 
errorMessage  ,
;, -
} 	
public		 
string		 
ErrorMessage		 "
{		# $
get		% (
;		( )
set		* -
;		- .
}		/ 0
}

 
} ‡'
sC:\Users\alexg\Documents\GitHub\Room-with-a-View\UserManagementMicroservice\UserManagementMicroservice\Utils\Jwt.cs
	namespace

 	&
UserManagementMicroservice


 $
.

$ %
Utils

% *
{ 
public 

static 
class 
Jwt 
{ 
public 
static 
string 
	CreateJWT &
(& '
int' *
userId+ 1
,1 2
int3 6
time7 ;
); <
{ 	
var 
token 
= 
new 

JwtBuilder &
(& '
)' (
. 
WithAlgorithm )
() *
new* -
HMACSHA256Algorithm. A
(A B
)B C
)C D
. 

WithSecret &
(& '
$str' Q
)Q R
. 
AddClaim $
($ %
$str% *
,* +
DateTimeOffset, :
.: ;
UtcNow; A
.A B
AddHoursB J
(J K
timeK O
)O P
.P Q
ToUnixTimeSecondsQ b
(b c
)c d
)d e
. 
AddClaim $
($ %
$str% -
,- .
userId/ 5
)5 6
. 
Encode "
(" #
)# $
;$ %
return 
token 
; 
} 	
public 
static 
string 
CheckJWT %
(% &
string& ,
jwt- 0
)0 1
{ 	
string 
json 
; 
try 
{ 
IJsonSerializer 

serializer  *
=+ ,
new- 0
JsonNetSerializer1 B
(B C
)C D
;D E
var 
provider 
= 
new "
UtcDateTimeProvider# 6
(6 7
)7 8
;8 9
IJwtValidator   
	validator   '
=  ( )
new  * -
JwtValidator  . :
(  : ;

serializer  ; E
,  E F
provider  G O
)  O P
;  P Q
IBase64UrlEncoder!! !

urlEncoder!!" ,
=!!- .
new!!/ 2
JwtBase64UrlEncoder!!3 F
(!!F G
)!!G H
;!!H I
IJwtAlgorithm"" 
	algorithm"" '
=""( )
new""* -
HMACSHA256Algorithm"". A
(""A B
)""B C
;""C D
IJwtDecoder## 
decoder## #
=##$ %
new##& )

JwtDecoder##* 4
(##4 5

serializer##5 ?
,##? @
	validator##A J
,##J K

urlEncoder##L V
,##V W
	algorithm##X a
)##a b
;##b c
json$$ 
=$$ 
decoder$$ 
.$$ 
Decode$$ %
($$% &
jwt$$& )
,$$) *
$str$$+ U
,$$U V
verify$$W ]
:$$] ^
true$$_ c
)$$c d
;$$d e
}%% 
catch&& 
(&& !
TokenExpiredException&& (
)&&( )
{'' 
return(( 
$str(( *
;((* +
})) 
catch** 
(** *
SignatureVerificationException** 1
)**1 2
{++ 
return,, 
$str,, 4
;,,4 5
}-- 
return.. 
json.. 
;.. 
}// 	
public11 
static11 
bool11 

IsValidJWT11 %
(11% &
string11& ,
jwt11- 0
)110 1
{22 	
if33 
(33 
jwt33 
==33 
$str33 )
||33* ,
jwt33- 0
==331 3
$str334 Q
)33Q R
{44 
return55 
false55 
;55 
}66 
return77 
true77 
;77 
}88 	
public:: 
static:: 
int:: 
ExtractUserId:: '
(::' (
string::( .
jwt::/ 2
)::2 3
{;; 	
string<< 
claims<< 
=<< 
jwt<< 
.<<  
Split<<  %
(<<% &
$char<<& )
)<<) *
.<<* +
ToList<<+ 1
(<<1 2
)<<2 3
[<<3 4
$num<<4 5
]<<5 6
.<<6 7
Split<<7 <
(<<< =
$char<<= @
)<<@ A
.<<A B
ToList<<B H
(<<H I
)<<I J
[<<J K
$num<<K L
]<<L M
;<<M N
string== 
id== 
=== 
claims== 
.== 
Remove== %
(==% &
claims==& ,
.==, -
Length==- 3
-==4 5
$num==6 7
)==7 8
;==8 9
return>> 
Int32>> 
.>> 
Parse>> 
(>> 
id>> !
)>>! "
;>>" #
}?? 	
}@@ 
}AA 